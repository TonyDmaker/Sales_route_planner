<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Route Planner â€” base_shell_v3 (repeat)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; }
  #app { position:relative; height:100vh; width:100vw; overflow:hidden; }
  #map { position:absolute; inset:0; height:100%; width:100%; }
  .panel {
    position:absolute; z-index:1000; background:rgba(255,255,255,0.98);
    border-radius:12px; padding:12px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    box-shadow:0 2px 10px rgba(0,0,0,0.15); font-size:14px;
    user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .legend { top:10px; left:10px; }
  .row { display:flex; align-items:center; gap:6px; margin:4px 0; }
  .marker-dot { width:18px; height:18px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 3px rgba(0,0,0,0.5); }
  .car-emoji { font-size:26px; line-height:26px; transform:translate(-2px,-2px); }
  .fab {
    position:absolute; top:10px; right:10px; z-index:1103;
    width:44px; height:44px; border-radius:50%; border:none;
    background:#111; color:#fff; font-size:22px; line-height:44px; text-align:center;
    box-shadow:0 3px 10px rgba(0,0,0,0.3); cursor:pointer;
  }
  .toolbar { top:60px; right:10px; width:300px; max-width:92vw; display:none; max-height:70vh; overflow:auto; }
  .toolbar.show { display:block; }
  .btn { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#f7f7f7; cursor:pointer; margin:2px 4px 2px 0; }
  /* Palette (simple, no shield) */
  #palette { position:absolute; display:none; z-index:1102; background:#fff; border-radius:12px; padding:8px; box-shadow:0 4px 12px rgba(0,0,0,.25); }
  #palette .opt { width:36px; height:36px; border-radius:50%; border:2px solid #fff; display:inline-flex; align-items:center; justify-content:center; margin:6px; box-shadow:0 0 4px rgba(0,0,0,.2); }
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <button id="menuBtn" class="fab" title="Settings">â˜°</button>

  <div class="panel legend" id="legend">
    <div style="font-weight:700;margin-bottom:6px;">Legend</div>
    <div class="row"><div class="marker-dot" style="background:#000000;"></div> Not visited</div>
    <div class="row"><div class="marker-dot" style="background:#3498db;"></div> Visited</div>
    <div class="row"><div class="marker-dot" style="background:#f1c40f;"></div> Followâ€‘up</div>
    <div class="row"><div class="marker-dot" style="background:#2ecc71;"></div> Wants to buy</div>
    <div class="row"><div class="marker-dot" style="background:#e74c3c;"></div> No soliciting</div>
    <div class="row"><span class="car-emoji">ðŸš—</span> Parking</div>
  </div>

  <div class="panel toolbar" id="menu">
    <div style="font-weight:700;margin-bottom:6px;">Menu</div>
    <div class="row">
      <button class="btn" id="clearPinsBtn">Clear pins</button>
    </div>
  </div>

  <div id="palette"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Map init
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
map.setView([37.773972,-122.431297], 13);
if (navigator.geolocation) map.locate({ setView:true, maxZoom:18 });
window.addEventListener('load', ()=> setTimeout(()=> map.invalidateSize(), 100));

// Menu
const menu = document.getElementById('menu');
document.getElementById('menuBtn').onclick = ()=> menu.classList.toggle('show');
document.addEventListener('pointerdown', (e)=>{
  const t=e.target; if(!(t.closest('.toolbar')||t.closest('.fab')||t.closest('.leaflet-control'))) menu.classList.remove('show');
},{passive:true});

// Pins
const PALETTE = ['#000000','#3498db','#f1c40f','#2ecc71','#e74c3c'];
const palette = document.getElementById('palette');
let pressPt=null, pressLL=null, longTimer=null;
function buildPalette(){
  palette.innerHTML = PALETTE.map(c=>`<div class="opt" data-color="${c}" style="background:${c}"></div>`).join('')
    + `<div class="opt" data-car="1" style="background:#fff;">ðŸš—</div>`;
}
function showPalette(pt){
  buildPalette();
  palette.style.left = (pt.x-110)+'px';
  palette.style.top = (pt.y-80)+'px';
  palette.style.display = 'block';
}
function hidePalette(){ palette.style.display='none'; }

const pins = new Map();
function dot(color){ return L.divIcon({className:'',html:`<div class="marker-dot" style="background:${color}"></div>`,iconSize:[18,18],iconAnchor:[9,9]}); }
function addPin(ll, color){ const id='p'+Date.now()+Math.random(); const m=L.marker(ll,{icon:dot(color)}).addTo(map); pins.set(id,{id, m}); }
let car=null, carMarker=null;
function carIcon(){ return L.divIcon({className:'',html:`<div class="car-emoji">ðŸš—</div>`,iconSize:[26,26],iconAnchor:[13,13]}); }
function placeCar(ll){ if(carMarker) carMarker.remove(); car=ll; carMarker=L.marker(ll,{icon:carIcon()}).addTo(map); bindCarDrag(); }

function bindCarDrag(){
  if(!carMarker) return;
  const icon=carMarker._icon; if(!icon) return;
  let timer=null, dragging=false, pointerId=null;
  const offset={x:-16,y:-24};
  icon.addEventListener('pointerdown', (e)=>{
    if(e.pointerType==='touch' && e.isPrimary===false) return;
    e.preventDefault();
    clearTimeout(timer);
    timer=setTimeout(()=>{
      dragging=true; pointerId=e.pointerId;
      map.dragging.disable(); map.touchZoom.disable();
    },700);
  }, {passive:false});
  icon.addEventListener('pointermove', (e)=>{
    if(!dragging || e.pointerId!==pointerId) return;
    e.preventDefault();
    const pt=map.mouseEventToContainerPoint(e);
    const pinPt={x:pt.x+offset.x,y:pt.y+offset.y};
    const ll=map.containerPointToLatLng(pinPt);
    carMarker.setLatLng(ll);
  }, {passive:false});
  function endDrag(e){
    clearTimeout(timer);
    if(dragging && e.pointerId===pointerId){
      e.preventDefault();
      const pt=map.mouseEventToContainerPoint(e);
      const pinPt={x:pt.x+offset.x,y:pt.y+offset.y};
      const ll=map.containerPointToLatLng(pinPt);
      placeCar(ll);
    }
    dragging=false; pointerId=null;
    map.dragging.enable(); map.touchZoom.enable();
  }
  icon.addEventListener('pointerup', endDrag, {passive:false});
  icon.addEventListener('pointercancel', endDrag, {passive:false});
}

// Long press to open palette
const mapEl = map.getContainer();
mapEl.addEventListener('pointerdown', (e)=>{
  if(e.target.closest('.leaflet-marker-icon')) return;
  if(e.pointerType==='touch' && e.isPrimary===false) return;
  pressPt = map.mouseEventToContainerPoint(e);
  pressLL = map.containerPointToLatLng(pressPt);
  clearTimeout(longTimer);
  longTimer = setTimeout(()=>{ showPalette(pressPt); }, 1000);
}, {passive:false});
mapEl.addEventListener('pointermove', (e)=>{
  if(!longTimer) return;
  const pt=map.mouseEventToContainerPoint(e);
  if(Math.hypot(pt.x-pressPt.x, pt.y-pressPt.y)>8){ clearTimeout(longTimer); longTimer=null; }
}, {passive:false});
mapEl.addEventListener('pointerup', (e)=>{
  if(longTimer){ clearTimeout(longTimer); longTimer=null; }
}, {passive:false});

// Palette click (simple tap)
palette.addEventListener('pointerup', (e)=>{
  const opt = e.target.closest('.opt');
  if(!opt) return;
  if(opt.hasAttribute('data-car')){ placeCar(pressLL); }
  else { addPin(pressLL, opt.getAttribute('data-color')); }
  hidePalette();
}, {passive:false});

// Clear pins
document.getElementById('clearPinsBtn').onclick = ()=>{
  pins.forEach(p=> p.m.remove());
  pins.clear();
  menu.classList.remove('show');
};
</script>
</body>
</html>
