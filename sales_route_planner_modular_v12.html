<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sales Route Planner â€” v12 (robust touch + draw)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .panel {
      position: absolute; z-index: 1000; background: rgba(255,255,255,0.98);
      border-radius: 12px; padding: 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 14px;
    }
    .legend { top: 10px; left: 10px; }
    .toolbar { top: 60px; right: 10px; width: 320px; max-width: 92vw; max-height: 70vh; overflow: auto; display: none; }
    .toolbar.show { display: block; }
    .row { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
    .btn {
      display: inline-block; padding: 6px 10px; margin: 2px 4px 2px 0; border: 1px solid #ddd; border-radius: 8px;
      background: #f7f7f7; cursor: pointer; user-select: none;
    }
    .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .btn.active { background: #e5f1ff; border-color: #b3d2ff; }
    .marker-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
    .car-emoji { font-size:26px; line-height:26px; }
    .palette {
      position:absolute; z-index:1100; background:#fff; border-radius:12px; padding:8px; display:none;
      box-shadow:0 4px 12px rgba(0,0,0,0.25); border:1px solid #0001;
    }
    .palette .opt { width:40px; height:40px; border-radius:50%; border:2px solid #fff; display:inline-flex; align-items:center; justify-content:center; margin:6px; box-shadow:0 0 4px rgba(0,0,0,.2); }
    .palette .selected { outline:3px solid rgba(0,0,0,0.25); }
    .fab {
      position: absolute; top: 10px; right: 10px; z-index: 1101;
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: #111; color: #fff; font-size: 22px; line-height: 44px; text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3); cursor: pointer;
    }
    .toast { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.65); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:1200; }
    .draw-hint { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.7); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:1200; }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="menuBtn" class="fab" title="Settings">â˜°</button>
  <div id="toast" class="toast"></div>
  <div id="drawHint" class="draw-hint">Draw a loop around the car, lift to finish</div>

  <div class="panel legend" id="legendPanel">
    <div style="font-weight:700;margin-bottom:6px;">Legend</div>
    <div class="row"><div class="marker-dot" style="background:#000;"></div> Black â€” Not visited</div>
    <div class="row"><div class="marker-dot" style="background:#3498db;"></div> Blue â€” Visited</div>
    <div class="row"><div class="marker-dot" style="background:#f1c40f;"></div> Yellow â€” Followâ€‘up</div>
    <div class="row"><div class="marker-dot" style="background:#2ecc71;"></div> Green â€” Wants to buy</div>
    <div class="row"><div class="marker-dot" style="background:#e74c3c;"></div> Red â€” No soliciting</div>
    <div class="row"><span class="car-emoji">ðŸš—</span> Car (start/end)</div>
  </div>

  <div class="panel toolbar" id="settingsPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Settings</div>
      <button class="btn" id="closeSettings">Close</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Pins</div>
    <div class="row">
      <button class="btn" id="exportPins">Export</button>
      <button class="btn" id="importPins">Import</button>
      <input type="file" id="importPinsFile" accept="application/json" style="display:none;">
      <button class="btn" id="clearPins">Clear</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Car / Area</div>
    <div class="row">
      <button class="btn" id="setCarGPS">Set car at my GPS</button>
      <button class="btn" id="centerCar">Center on car</button>
      <button class="btn" id="clearCar">Clear car</button>
    </div>
    <div class="row">
      <button class="btn" id="drawPerimeterBtn">Draw perimeter</button>
      <button class="btn" id="clearPerimeterBtn">Clear perimeter</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Route</div>
    <div class="row">
      <button class="btn primary" id="autorouteBtn">Autoâ€‘route within perimeter</button>
      <button class="btn" id="clearRouteBtn">Clear route</button>
      <button class="btn" id="resetAllBtn">Reset all</button>
    </div>
  </div>

  <div id="palette" class="palette"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    function toast(msg,ms=900){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
    function newId(){ return 'p_'+Date.now()+'_'+Math.floor(Math.random()*1e6); }
    const COLORS = { NOT_VISITED:'#000000', VISITED:'#3498db', FOLLOW_UP:'#f1c40f', WANTS_BUY:'#2ecc71', NO_SOLICIT:'#e74c3c' };
    const COLOR_LIST=[COLORS.NOT_VISITED, COLORS.VISITED, COLORS.FOLLOW_UP, COLORS.WANTS_BUY, COLORS.NO_SOLICIT];

    const map = L.map('map').fitWorld();
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    map.locate({setView:true,maxZoom:18});
    let you=null; map.on('locationfound',e=>{ if(!you){ you=L.marker(e.latlng).addTo(map).bindPopup('You'); } });

    const K_PINS='srp_v12_pins', K_CAR='srp_v12_car', K_PERIM='srp_v12_perim', K_ROUTE='srp_v12_route';

    const pins=new Map();
    function dot(color){ return L.divIcon({className:'',html:`<div class="marker-dot" style="background:${color}"></div>`,iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-9]}); }
    function savePins(){ localStorage.setItem(K_PINS, JSON.stringify(Array.from(pins.values()).map(({_m,...o})=>o))); }
    function loadPins(){ try{return JSON.parse(localStorage.getItem(K_PINS)||'[]')}catch{return[]} }
    function pinPopupHtml(p){ return `<div><div style="font-weight:700;margin-bottom:6px;">House note</div>
      <label>Label</label><input id="t_${p.id}" style="width:100%;margin:2px 0 6px;" value="${(p.title||'').replace(/"/g,'&quot;')}">
      <label>Notes</label><textarea id="n_${p.id}" rows="3" style="width:100%;margin-top:2px;">${(p.notes||'')}</textarea>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
        ${COLOR_LIST.map(c=>`<button data-c="${c}" class="btn" style="background:${c};border-color:${c};${c==='#000000'?'color:#fff;':''}">&nbsp;</button>`).join('')}
        <button class="btn" id="del_${p.id}" style="background:#fee;border-color:#fee;">Delete</button>
      </div></div>`; }
    function bindPinPopup(m,p){
      m.bindPopup(pinPopupHtml(p));
      m.on('popupopen',()=>{
        const el=m.getPopup().getElement();
        el.querySelectorAll('button[data-c]').forEach(b=>b.addEventListener('click',()=>{
          p.color=b.getAttribute('data-c'); m.setIcon(dot(p.color)); savePins();
        }));
        el.querySelector('#del_'+p.id).addEventListener('click',()=>{ map.removeLayer(m); pins.delete(p.id); savePins(); });
        el.querySelector('#t_'+p.id).addEventListener('input',e=>{ p.title=e.target.value; savePins(); });
        el.querySelector('#n_'+p.id).addEventListener('input',e=>{ p.notes=e.target.value; savePins(); });
      });
    }
    function addPinLL(latlng,color=COLORS.NOT_VISITED){
      const p={id:newId(),lat:latlng.lat,lng:latlng.lng,color,title:'',notes:''};
      const m=L.marker(latlng,{icon:dot(color)}).addTo(map);
      p._m=m; pins.set(p.id,p); bindPinPopup(m,p); savePins();
    }
    loadPins().forEach(o=>{ const m=L.marker([o.lat,o.lng],{icon:dot(o.color||COLORS.NOT_VISITED)}).addTo(map); const p={...o,_m:m}; pins.set(p.id,p); bindPinPopup(m,p); });

    let car=null, carMarker=null;
    function carIcon(){ return L.divIcon({className:'',html:`<div class="car-emoji">ðŸš—</div>`,iconSize:[26,26],iconAnchor:[13,13]}); }
    function placeCar(ll){ car={lat:ll.lat,lng:ll.lng}; localStorage.setItem(K_CAR, JSON.stringify(car));
      if(carMarker) map.removeLayer(carMarker);
      carMarker=L.marker(ll,{icon:carIcon(),draggable:false}).addTo(map);
      enableCarDrag();
    }
    (function loadCar(){ try{ const c=JSON.parse(localStorage.getItem(K_CAR)||'null'); if(c){ placeCar(c); } }catch{} })();

    function enableCarDrag(){
      if(!carMarker) return;
      const iconEl = carMarker._icon;
      let holdTimer=null, dragging=false, pointerId=null;
      const offset={x:-16,y:-24};
      function onPointerDown(e){
        if(e.pointerType==='touch' && e.isPrimary===false) return;
        if(e.target!==iconEl) return;
        e.preventDefault();
        pointerId = e.pointerId;
        iconEl.setPointerCapture(pointerId);
        holdTimer=setTimeout(()=>{
          dragging=true;
          map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
        },700);
      }
      function onPointerMove(e){
        if(e.pointerId!==pointerId) return;
        if(!dragging) return;
        e.preventDefault();
        const pt = map.mouseEventToContainerPoint(e);
        const pinPt = L.point(pt.x+offset.x, pt.y+offset.y);
        const ll = map.containerPointToLatLng(pinPt);
        carMarker.setLatLng(ll);
      }
      function endDrag(e){
        if(e.pointerId!==pointerId) return;
        clearTimeout(holdTimer);
        if(dragging){
          e.preventDefault();
          placeCar(carMarker.getLatLng());
          map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
        }
        dragging=false; pointerId=null;
        try{ iconEl.releasePointerCapture(e.pointerId); }catch{}
      }
      iconEl.addEventListener('pointerdown', onPointerDown);
      iconEl.addEventListener('pointermove', onPointerMove);
      iconEl.addEventListener('pointerup', endDrag);
      iconEl.addEventListener('pointercancel', endDrag);
    }

    const settings=document.getElementById('settingsPanel');
    document.getElementById('menuBtn').onclick=()=>settings.classList.toggle('show');
    document.getElementById('closeSettings').onclick=()=>settings.classList.remove('show');
    document.addEventListener('pointerdown',e=>{
      if(!(e.target.closest('.toolbar')||e.target.closest('.fab')||e.target.closest('.leaflet-control'))) settings.classList.remove('show');
    }, {passive:true});

    const palette=document.getElementById('palette');
    let lpTimer=null, lpPt=null, lpLL=null, paletteOpen=false, paletteChoice=null, activePointers=0, lpPointerId=null;
    function buildPalette(){
      palette.innerHTML = COLOR_LIST.map(c=>`<div class="opt" data-type="note" data-color="${c}" style="background:${c};${c==='#000000'?'color:#fff;':''}"></div>`).join('')
        + `<div class="opt" data-type="car" style="background:#fff;">ðŸš—</div>`;
    }
    function showPalette(pt){
      buildPalette();
      palette.style.left=(pt.x-120)+'px'; palette.style.top=(pt.y-90)+'px';
      palette.style.display='block'; paletteOpen=true; paletteChoice=null;
      map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
      map.getContainer().style.touchAction='none';
    }
    function hidePalette(){
      palette.style.display='none'; paletteOpen=false;
      map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
      map.getContainer().style.touchAction='';
    }
    const mapEl = map.getContainer();
    mapEl.addEventListener('pointerdown', (e)=>{
      if(e.target.closest('.leaflet-marker-icon')) return;
      activePointers++;
      if(activePointers>1){
        if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; }
        return;
      }
      lpPointerId = e.pointerId;
      lpPt = map.mouseEventToContainerPoint(e);
      lpLL = map.containerPointToLatLng(lpPt);
      lpTimer = setTimeout(()=>{ showPalette(lpPt); }, 1000);
    });
    mapEl.addEventListener('pointermove', (e)=>{
      if(e.pointerId!==lpPointerId) return;
      if(lpTimer){
        const pt=map.mouseEventToContainerPoint(e);
        if(Math.hypot(pt.x-lpPt.x, pt.y-lpPt.y)>8){ clearTimeout(lpTimer); lpTimer=null; }
      }
      if(paletteOpen){
        e.preventDefault();
        const el = document.elementFromPoint(e.clientX, e.clientY);
        if(el && el.classList && el.classList.contains('opt')){
          Array.from(palette.children).forEach(x=>x.classList.toggle('selected', x===el));
          paletteChoice = el.getAttribute('data-type')==='car' ? 'car' : ('note:'+el.getAttribute('data-color'));
        }
      }
    }, {passive:false});
    function finalizePalette(){
      if(!paletteOpen) return;
      const choice = paletteChoice;
      hidePalette();
      if(choice==='car'){
        if(you){ placeCar(you.getLatLng()); } else { placeCar(lpLL); }
      } else if(choice && choice.startsWith('note:')){
        addPinLL(lpLL, choice.split(':')[1]);
      }
    }
    mapEl.addEventListener('pointerup', (e)=>{
      if(e.pointerId===lpPointerId){
        if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; }
        finalizePalette();
      }
      activePointers=Math.max(0, activePointers-1);
    });
    mapEl.addEventListener('pointercancel', (e)=>{
      if(e.pointerId===lpPointerId){
        if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; }
        hidePalette();
      }
      activePointers=Math.max(0, activePointers-1);
    });

    // Import/export/clear pins
    document.getElementById('exportPins').onclick=()=>{
      const data=JSON.stringify(Array.from(pins.values()).map(({_m,...o})=>o),null,2);
      const url=URL.createObjectURL(new Blob([data],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='pins.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('importPins').onclick=()=>document.getElementById('importPinsFile').click();
    document.getElementById('importPinsFile').addEventListener('change',ev=>{
      const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{
        try{ const arr=JSON.parse(r.result); pins.forEach(p=>map.removeLayer(p._m)); pins.clear();
          arr.forEach(o=>{ const m=L.marker([o.lat,o.lng],{icon:dot(o.color||COLORS.NOT_VISITED)}).addTo(map); const p={...o,_m:m}; pins.set(p.id,p); bindPinPopup(m,p); });
          savePins(); toast('Pins imported'); }catch(e){ alert('Import failed'); }
      }; r.readAsText(f);
    });
    document.getElementById('clearPins').onclick=()=>{ pins.forEach(p=>map.removeLayer(p._m)); pins.clear(); savePins(); };

    // Perimeter drawing
    let drawing=false, drawPointerId=null, perim=null, perimPts=[];
    const perimStyle={color:'#2563eb', weight:3, opacity:0.9, fill:true, fillOpacity:0.08};
    function drawPerim(){ if(perim) map.removeLayer(perim); if(perimPts.length) perim=L.polygon(perimPts, perimStyle).addTo(map); }
    function savePerim(){ localStorage.setItem(K_PERIM, JSON.stringify(perimPts.map(ll=>({lat:ll.lat,lng:ll.lng})))); }
    function loadPerim(){ try{ const a=JSON.parse(localStorage.getItem(K_PERIM)||'null'); if(a&&a.length){ perimPts=a.map(o=>L.latLng(o.lat,o.lng)); drawPerim(); } }catch{} }
    loadPerim();
    const drawHintEl = document.getElementById('drawHint');
    document.getElementById('drawPerimeterBtn').onclick=()=>{
      drawing=false; perimPts=[]; drawPerim();
      toast('Drawingâ€¦'); drawHintEl.style.display='block';
    };
    document.getElementById('clearPerimeterBtn').onclick=()=>{ perimPts=[]; drawPerim(); localStorage.removeItem(K_PERIM); toast('Perimeter cleared'); };
    mapEl.addEventListener('pointerdown', (e)=>{
      if(drawHintEl.style.display!=='block') return;
      if(drawing) return;
      if(e.isPrimary===false) return;
      drawing=true; drawPointerId=e.pointerId;
      map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
      mapEl.style.touchAction='none';
      perimPts=[ map.mouseEventToLatLng(e) ];
      drawPerim();
    });
    mapEl.addEventListener('pointermove', (e)=>{
      if(!drawing || e.pointerId!==drawPointerId) return;
      e.preventDefault();
      if(e.buttons===0){ return; }
      const ll = map.mouseEventToLatLng(e);
      perimPts.push(ll);
      drawPerim();
    }, {passive:false});
    function finishDraw(){
      if(!drawing) return;
      drawing=false; drawPointerId=null;
      map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
      mapEl.style.touchAction='';
      drawHintEl.style.display='none';
      if(perimPts.length>2){ savePerim(); toast('Perimeter saved'); } else { perimPts=[]; drawPerim(); }
    }
    mapEl.addEventListener('pointerup', (e)=>{ if(e.pointerId===drawPointerId) finishDraw(); });
    mapEl.addEventListener('pointercancel', (e)=>{ if(e.pointerId===drawPointerId) finishDraw(); });

    // Auto-route sweep
    let route=null, progress=null;
    function clearRoute(){ if(route){ map.removeLayer(route);} if(progress){ map.removeLayer(progress);} route=progress=null; localStorage.removeItem(K_ROUTE); }
    function drawRoute(lls){
      if(route) map.removeLayer(route);
      route=L.polyline(lls,{color:'#8e44ad',weight:5,opacity:0.85}).addTo(map);
      if(progress) map.removeLayer(progress);
      progress=L.polyline([], {color:'#27ae60',weight:6,opacity:0.9}).addTo(map);
    }
    function distM(a,b){
      const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(A));
    }
    function projectPointToPolyline(P, line){
      if(!line||line.length<2) return {ok:false};
      let best={ok:false, perp:Infinity, along:0}; let cum=0;
      for(let i=0;i<line.length-1;i++){ const A=line[i], B=line[i+1]; const res=projSeg(P,A,B,cum); if(res.perp<best.perp){ best=res; } cum=res.cumNext; }
      return best;
    }
    function projSeg(P,A,B,cumBefore){
      const pA=map.latLngToLayerPoint(A), pB=map.latLngToLayerPoint(B), pP=map.latLngToLayerPoint(P);
      const AB={x:pB.x-pA.x,y:pB.y-pA.y}, AP={x:pP.x-pA.x,y:pP.y-pA.y};
      const ab2=AB.x*AB.x+AB.y*AB.y;
    }
  </script>
</body>
</html>
