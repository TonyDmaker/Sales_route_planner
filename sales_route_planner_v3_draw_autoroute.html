<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Route Planner â€” v3 + Draw + Autoroute</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; }
  #app { position:relative; height:100vh; width:100vw; overflow:hidden; }
  #map { position:absolute; inset:0; height:100%; width:100%; z-index: 1; }
  #drawOverlay { position:absolute; inset:0; z-index: 3; display:none; touch-action:none; }
  .panel { position:absolute; z-index:5; background:rgba(255,255,255,0.98); border-radius:12px; padding:12px;
           font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; box-shadow:0 2px 10px rgba(0,0,0,0.15); font-size:14px;
           user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
  .legend { top:10px; left:10px; }
  .toolbar { top:60px; right:10px; width:320px; max-width:92vw; max-height:70vh; overflow:auto; display:none; }
  .toolbar.show { display:block; }
  .row { display:flex; align-items:center; gap:6px; margin:4px 0; flex-wrap:wrap; }
  .btn { display:inline-block; padding:6px 10px; margin:2px 4px 2px 0; border:1px solid #ddd; border-radius:8px; background:#f7f7f7; cursor:pointer; user-select:none; }
  .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
  .marker-dot { width:18px; height:18px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 3px rgba(0,0,0,0.5); }
  .car-emoji { font-size:26px; line-height:26px; transform:translate(-2px,-2px); }
  .palette { position:absolute; z-index:6; background:#fff; border-radius:12px; padding:8px; display:none; box-shadow:0 4px 12px rgba(0,0,0,0.25); border:1px solid #0001; }
  .palette .opt { width:36px; height:36px; border-radius:50%; border:2px solid #fff; display:inline-flex; align-items:center; justify-content:center; margin:6px; box-shadow:0 0 4px rgba(0,0,0,.2); }
  .fab { position:absolute; top:10px; right:10px; z-index:7; width:44px; height:44px; border-radius:50%; border:none; background:#111; color:#fff; font-size:22px; line-height:44px; text-align:center; box-shadow:0 3px 10px rgba(0,0,0,0.3); cursor:pointer; }
  .toast { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.65); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:8; }
  .hint { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.7); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:8; }
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <canvas id="drawOverlay"></canvas>

  <button id="menuBtn" class="fab" title="Settings">â˜°</button>
  <div id="toast" class="toast"></div>
  <div id="drawHint" class="hint">Draw a loop, then lift to save</div>

  <div class="panel legend" id="legendPanel">
    <div style="font-weight:700;margin-bottom:6px;">Legend</div>
    <div class="row"><div class="marker-dot" style="background:#000000;"></div> Not visited</div>
    <div class="row"><div class="marker-dot" style="background:#3498db;"></div> Visited</div>
    <div class="row"><div class="marker-dot" style="background:#f1c40f;"></div> Followâ€‘up</div>
    <div class="row"><div class="marker-dot" style="background:#2ecc71;"></div> Wants to buy</div>
    <div class="row"><div class="marker-dot" style="background:#e74c3c;"></div> No soliciting</div>
    <div class="row"><span class="car-emoji">ðŸš—</span> Parking (start/end)</div>
  </div>

  <div class="panel toolbar" id="settingsPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Settings</div>
      <button class="btn" id="closeSettings">Close</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Pins</div>
    <div class="row">
      <button class="btn" id="clearPins">Clear pins</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Parking & Area</div>
    <div class="row">
      <button class="btn" id="setParking">Set Parking (tap map)</button>
      <button class="btn" id="clearCar">Clear Parking</button>
    </div>
    <div class="row">
      <button class="btn" id="drawPerimeterBtn">Draw perimeter</button>
      <button class="btn" id="clearPerimeterBtn">Clear perimeter</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Route</div>
    <div class="row">
      <button class="btn primary" id="genRouteBtn">Generate route</button>
      <select id="routeMode">
        <option value="serpentine" selected>Serpentine</option>
        <option value="sidewalk">Oneâ€‘side street</option>
      </select>
      <button class="btn" id="clearRouteBtn">Clear route</button>
    </div>
  </div>

  <div id="palette" class="palette"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
function toast(msg,ms=900){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
const COLOR = { NOT_VISITED:'#000000', VISITED:'#3498db', FOLLOW_UP:'#f1c40f', WANTS:'#2ecc71', NO_SOLICIT:'#e74c3c' };
const PALETTE = [COLOR.NOT_VISITED,COLOR.VISITED,COLOR.FOLLOW_UP,COLOR.WANTS,COLOR.NO_SOLICIT];

const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
map.setView([37.773972,-122.431297], 13);
if (navigator.geolocation) map.locate({setView:true,maxZoom:18});
window.addEventListener('load', ()=> setTimeout(()=> map.invalidateSize(), 100));

const settings=document.getElementById('settingsPanel');
document.getElementById('menuBtn').onclick=()=>settings.classList.toggle('show');
document.getElementById('closeSettings').onclick=()=>settings.classList.remove('show');
document.addEventListener('pointerdown',(e)=>{
  const t=e.target;
  if(!(t.closest('.toolbar')||t.closest('.fab')||t.closest('.leaflet-control'))) settings.classList.remove('show');
},{passive:true});
function closeMenuAfter(fn){ return (...args)=>{ settings.classList.remove('show'); fn(...args); }; }

const pins=new Set();
function dot(color){ return L.divIcon({className:'',html:`<div class="marker-dot" style="background:${color}"></div>`,iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-9]}); }
function addPinAt(latlng,color){ const m=L.marker(latlng,{icon:dot(color)}).addTo(map); pins.add(m); return m; }
document.getElementById('clearPins').onclick=closeMenuAfter(()=>{ pins.forEach(m=>m.remove()); pins.clear(); });

const palette=document.getElementById('palette');
let pressPt=null, pressLL=null, longTimer=null;
function buildPalette(){
  palette.innerHTML = PALETTE.map(c=>`<div class="opt" data-color="${c}" style="background:${c}"></div>`).join('') + `<div class="opt" data-car="1" style="background:#fff;">ðŸš—</div>`;
}
function showPalette(pt){ buildPalette(); palette.style.left=(pt.x-110)+'px'; palette.style.top=(pt.y-80)+'px'; palette.style.display='block'; }
function hidePalette(){ palette.style.display='none'; }
const mapEl=map.getContainer();
mapEl.addEventListener('pointerdown',(e)=>{
  if(e.target.closest('.leaflet-marker-icon')) return;
  if(e.pointerType==='touch' && e.isPrimary===false) return;
  pressPt=map.mouseEventToContainerPoint(e); pressLL=map.containerPointToLatLng(pressPt);
  clearTimeout(longTimer); longTimer=setTimeout(()=>{ showPalette(pressPt); },1000);
},{passive:false});
mapEl.addEventListener('pointermove',(e)=>{
  if(!longTimer) return; const pt=map.mouseEventToContainerPoint(e);
  if(Math.hypot(pt.x-pressPt.x, pt.y-pressPt.y)>8){ clearTimeout(longTimer); longTimer=null; }
},{passive:false});
mapEl.addEventListener('pointerup',(e)=>{ if(longTimer){ clearTimeout(longTimer); longTimer=null; } }, {passive:false});
palette.addEventListener('click',(e)=>{
  const opt=e.target.closest('.opt'); if(!opt) return;
  hidePalette();
  if(opt.dataset.car){ placeCar(pressLL); } else { addPinAt(pressLL, opt.dataset.color); }
});

let car=null, carMarker=null;
function carIcon(){ return L.divIcon({className:'',html:`<div class="car-emoji">ðŸš—</div>`,iconSize:[26,26],iconAnchor:[13,13]}); }
function placeCar(latlng){ if(carMarker) carMarker.remove(); car={lat:latlng.lat,lng:latlng.lng}; carMarker=L.marker(latlng,{icon:carIcon(),interactive:true}).addTo(map); bindCarDrag(); }
document.getElementById('setParking').onclick=closeMenuAfter(()=>{ toast('Tap map to set parking'); map.once('click', (e)=>placeCar(e.latlng)); });
document.getElementById('clearCar').onclick=closeMenuAfter(()=>{ if(carMarker){ carMarker.remove(); carMarker=null; } car=null; });
function bindCarDrag(){
  if(!carMarker) return;
  const icon=carMarker._icon; if(!icon) return;
  let timer=null, dragging=false, pointerId=null;
  const offset={x:-16,y:-24};
  function onDown(e){ if(e.pointerType==='touch' && e.isPrimary===false) return; e.preventDefault();
    clearTimeout(timer); timer=setTimeout(()=>{ dragging=true; pointerId=e.pointerId; map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); icon.setPointerCapture && icon.setPointerCapture(pointerId); },700); }
  function onMove(e){ if(!dragging || e.pointerId!==pointerId) return; e.preventDefault(); const pt=map.mouseEventToContainerPoint(e);
    const pinPt={x:pt.x+offset.x,y:pt.y+offset.y}; const ll=map.containerPointToLatLng(pinPt); carMarker.setLatLng(ll); }
  function onUp(e){ clearTimeout(timer); if(dragging && e.pointerId===pointerId){ e.preventDefault(); const pt=map.mouseEventToContainerPoint(e);
      const pinPt={x:pt.x+offset.x,y:pt.y+offset.y}; const ll=map.containerPointToLatLng(pinPt); placeCar(ll); }
    dragging=false; pointerId=null; map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable(); }
  icon.addEventListener('pointerdown', onDown, {passive:false}); icon.addEventListener('pointermove', onMove, {passive:false});
  icon.addEventListener('pointerup', onUp, {passive:false}); icon.addEventListener('pointercancel', onUp, {passive:false});
}

let drawing=false, drawPtsPx=[], perimPoly=null;
const canvas=document.getElementById('drawOverlay');
const ctx=canvas.getContext('2d');
function sizeCanvas(){ const rect=mapEl.getBoundingClientRect(); canvas.width=rect.width; canvas.height=rect.height; canvas.style.left=rect.left+'px'; canvas.style.top=rect.top+'px'; }
sizeCanvas(); window.addEventListener('resize', sizeCanvas);
function startDraw(){ drawing=true; drawPtsPx=[]; sizeCanvas(); canvas.style.display='block'; document.getElementById('drawHint').style.display='block'; map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); toast('Drawingâ€¦'); }
function endDraw(){ drawing=false; document.getElementById('drawHint').style.display='none'; canvas.style.display='none'; ctx.clearRect(0,0,canvas.width,canvas.height); map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
  if(drawPtsPx.length>2){ const lls=drawPtsPx.map(p=> map.containerPointToLatLng(L.point(p.x,p.y))); if(perimPoly) perimPoly.remove();
    perimPoly=L.polygon(lls,{color:'#2563eb',weight:3,opacity:0.9,fill:true,fillOpacity:0.08}).addTo(map); toast('Perimeter saved'); } }
document.getElementById('drawPerimeterBtn').onclick=closeMenuAfter(()=> startDraw());
document.getElementById('clearPerimeterBtn').onclick=closeMenuAfter(()=>{ if(perimPoly){ perimPoly.remove(); perimPoly=null; } });

canvas.addEventListener('pointerdown',(e)=>{
  if(!drawing) return;
  drawPtsPx=[]; const rect=mapEl.getBoundingClientRect();
  drawPtsPx.push({x:e.clientX-rect.left, y:e.clientY-rect.top});
  ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='orange'; ctx.lineWidth=3; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(drawPtsPx[0].x, drawPtsPx[0].y);
},{passive:false});
canvas.addEventListener('pointermove',(e)=>{
  if(!drawing) return; e.preventDefault();
  const rect=mapEl.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
  drawPtsPx.push({x,y}); ctx.lineTo(x,y); ctx.stroke();
},{passive:false});
canvas.addEventListener('pointerup',(e)=>{ if(drawing) endDraw(); }, {passive:false});
canvas.addEventListener('pointercancel',(e)=>{ if(drawing) endDraw(); }, {passive:false});

let route=null;
function clearRoute(){ if(route){ route.remove(); route=null; } }
document.getElementById('clearRouteBtn').onclick=closeMenuAfter(()=> clearRoute());
function distM(a,b){ const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(A)); }
function insidePolyLL(pt, poly){ const p=map.latLngToLayerPoint(pt); const arr=poly.map(ll=>map.latLngToLayerPoint(ll));
  let inside=false; for(let i=0,j=arr.length-1;i<arr.length;j=i++){ const xi=arr[i].x, yi=arr[i].y, xj=arr[j].x, yj=arr[j].y;
    const intersect = ((yi>p.y)!=(yj>p.y)) && (p.x < (xj-xi)*(p.y-yi)/(yj-yi)+xi); if(intersect) inside=!inside; } return inside; }
function serpentine(perimPts, startLL){
  const bbox=perimPts.reduce((b,ll)=>({minX:Math.min(b.minX,ll.lng), maxX:Math.max(b.maxX,ll.lng), minY:Math.min(b.minY,ll.lat), maxY:Math.max(b.maxY,ll.lat)}),{minX:Infinity,maxX:-Infinity,minY:Infinity,maxY:-Infinity});
  const spacingM=40; const mPerDegLat=111320; const dy=spacingM/mPerDegLat;
  const startLat=bbox.minY+dy/2, endLat=bbox.maxY-dy/2; const xs=[bbox.minX,bbox.maxX]; let lines=[]; let dir=0;
  for(let y=startLat; y<=endLat; y+=dy){
    const a=L.latLng(y, xs[dir?1:0]), b=L.latLng(y, xs[dir?0:1]); const samples=80; const seg=[];
    for(let i=0;i<=samples;i++){ const lng=a.lng+(b.lng-a.lng)*(i/samples); const ll=L.latLng(y,lng); if(insidePolyLL(ll, perimPts)) seg.push(ll); }
    if(seg.length>1){ lines.push(seg); dir=1-dir; }
  }
  const path=[startLL]; let cur=startLL;
  while(lines.length){
    let best={idx:0, rev:false, d:Infinity};
    lines.forEach((seg,idx)=>{ const a=seg[0], b=seg[seg.length-1]; const d1=distM(cur,a), d2=distM(cur,b); if(d1<best.d){best={idx,rev:false,d:d1}}; if(d2<best.d){best={idx,rev:true,d:d2}}; });
    const seg=lines.splice(best.idx,1)[0]; const use=best.rev? seg.slice().reverse(): seg; path.push(...use); cur=use[use.length-1];
  }
  path.push(startLL); return path;
}
function offsetPolyline(lls, meters){
  if(lls.length<2) return lls.slice();
  const out=[];
  for(let i=0;i<lls.length;i++){
    const P = map.latLngToLayerPoint(lls[i]);
    const A = map.latLngToLayerPoint(lls[Math.max(0,i-1)]);
    const B = map.latLngToLayerPoint(lls[Math.min(lls.length-1,i+1)]);
    const dx = B.x - A.x, dy = B.y - A.y; const len = Math.hypot(dx,dy)||1;
    const nx = -dy/len, ny = dx/len; const px = P.x + nx * meters, py = P.y + ny * meters;
    out.push(map.layerPointToLatLng(L.point(px,py)));
  }
  return out;
}
function sidewalk(perimPts, startLL){
  const spine=serpentine(perimPts,startLL);
  const A = map.latLngToLayerPoint(startLL);
  const B = map.latLngToLayerPoint(L.latLng(startLL.lat+0.0001,startLL.lng));
  const pxPerMeter = Math.abs(B.y - A.y) / (0.0001 * 111320);
  const offsetPx = 7 * pxPerMeter;
  const left=offsetPolyline(spine, offsetPx);
  const right=offsetPolyline(spine, -offsetPx);
  return [startLL, ...left, ...right.reverse(), startLL];
}
document.getElementById('genRouteBtn').onclick=closeMenuAfter(()=>{
  if(!perimPoly){ toast('Draw a perimeter first'); return; }
  if(!car){ toast('Set parking first'); return; }
  const mode=document.getElementById('routeMode').value;
  const perimPts=perimPoly.getLatLngs()[0];
  const start=L.latLng(car.lat,car.lng);
  const path = (mode==='sidewalk') ? sidewalk(perimPts,start) : serpentine(perimPts,start);
  if(route) route.remove();
  route=L.polyline(path,{color:'#8e44ad',weight:5,opacity:0.85}).addTo(map);
  toast('Route generated');
});
</script>
</body>
</html>
