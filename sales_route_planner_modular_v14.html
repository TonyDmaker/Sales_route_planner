<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sales Route Planner â€” v14</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    /* Global: prevent accidental text selection / callout */
    * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; -webkit-touch-callout: default; }
    /* Panels */
    .panel {
      position: absolute; z-index: 1000; background: rgba(255,255,255,0.98);
      border-radius: 12px; padding: 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 14px;
    }
    .legend { top: 10px; left: 10px; }
    .toolbar { top: 60px; right: 10px; width: 320px; max-width: 92vw; max-height: 70vh; overflow: auto; display: none; }
    .toolbar.show { display: block; }
    .row { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
    .btn {
      display: inline-block; padding: 6px 10px; margin: 2px 4px 2px 0; border: 1px solid #ddd; border-radius: 8px;
      background: #f7f7f7; cursor: pointer; user-select: none;
    }
    .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .marker-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
    .car-emoji { font-size:26px; line-height:26px; transform:translate(-2px,-2px) }
    .palette {
      position:absolute; z-index:1102; background:#fff; border-radius:12px; padding:8px; display:none;
      box-shadow:0 4px 12px rgba(0,0,0,0.25); border:1px solid #0001;
    }
    .palette .opt { width:36px; height:36px; border-radius:50%; border:2px solid #fff; display:inline-flex; align-items:center; justify-content:center; margin:6px; box-shadow:0 0 4px rgba(0,0,0,.2); }
    .palette .selected { outline:3px solid rgba(0,0,0,0.25); }
    .fab {
      position: absolute; top: 10px; right: 10px; z-index: 1101;
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: #111; color: #fff; font-size: 22px; line-height: 44px; text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3); cursor: pointer;
    }
    .toast { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.65); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:1200; }
    .draw-hint { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.7); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:1200; }

    /* Shield overlay to capture gestures while palette/drawing are active */
    #shield {
      position:absolute; inset:0; z-index:1100; display:none; /* below palette (1102), above map */
      background: rgba(0,0,0,0); /* fully transparent but captures events */
      touch-action: none; /* disable browser gestures on shield */
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="shield"></div>
  <button id="menuBtn" class="fab" title="Settings">â˜°</button>
  <div id="toast" class="toast"></div>
  <div id="drawHint" class="draw-hint">Draw a loop around the car, lift to finish</div>

  <div class="panel legend" id="legendPanel">
    <div style="font-weight:700;margin-bottom:6px;">Legend</div>
    <div class="row"><div class="marker-dot" style="background:#000000;"></div> Not visited</div>
    <div class="row"><div class="marker-dot" style="background:#3498db;"></div> Visited</div>
    <div class="row"><div class="marker-dot" style="background:#f1c40f;"></div> Followâ€‘up</div>
    <div class="row"><div class="marker-dot" style="background:#2ecc71;"></div> Wants to buy</div>
    <div class="row"><div class="marker-dot" style="background:#e74c3c;"></div> No soliciting</div>
    <div class="row"><span class="car-emoji">ðŸš—</span> Car (start/end)</div>
  </div>

  <div class="panel toolbar" id="settingsPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Settings</div>
      <button class="btn" id="closeSettings">Close</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Pins</div>
    <div class="row">
      <button class="btn" id="exportPins">Export</button>
      <button class="btn" id="importPins">Import</button>
      <input type="file" id="importPinsFile" accept="application/json" style="display:none;">
      <button class="btn" id="clearPins">Clear</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Car / Area</div>
    <div class="row">
      <button class="btn" id="setCarGPS">Set car at my GPS</button>
      <button class="btn" id="centerCar">Center on car</button>
      <button class="btn" id="clearCar">Clear car</button>
    </div>
    <div class="row">
      <button class="btn" id="drawPerimeterBtn">Draw perimeter</button>
      <button class="btn" id="clearPerimeterBtn">Clear perimeter</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Route</div>
    <div class="row">
      <button class="btn primary" id="autorouteBtn">Autoâ€‘route within perimeter</button>
      <button class="btn" id="clearRouteBtn">Clear route</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Danger zone</div>
    <div class="row">
      <button class="btn" id="resetAll">Reset all</button>
    </div>
  </div>

  <div id="palette" class="palette"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ===== Utility
    function toast(msg,ms=900){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
    const shield = document.getElementById('shield');
    function showShield(){ shield.style.display='block'; }
    function hideShield(){ shield.style.display='none'; }

    const map = L.map('map', { zoomControl: true }).fitWorld();
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    map.locate({setView:true,maxZoom:18});

    // ===== Storage keys
    const K_PINS='srp_v14_pins', K_CAR='srp_v14_car', K_PERIM='srp_v14_perim', K_ROUTE='srp_v14_route';

    // ===== You are here
    let you=null; map.on('locationfound',e=>{ if(!you){ you=L.marker(e.latlng).addTo(map).bindPopup('You'); } });

    // ===== Pins
    const COLOR_MAP = {
      NOT_VISITED: '#000000',
      VISITED: '#3498db',
      FOLLOW_UP: '#f1c40f',
      WANTS_TO_BUY: '#2ecc71',
      NO_SOLICITING: '#e74c3c'
    };
    const PALETTE = [COLOR_MAP.NOT_VISITED, COLOR_MAP.VISITED, COLOR_MAP.FOLLOW_UP, COLOR_MAP.WANTS_TO_BUY, COLOR_MAP.NO_SOLICITING];

    const pins=new Map();
    function savePins(){ localStorage.setItem(K_PINS, JSON.stringify(Array.from(pins.values()).map(p=>({id:p.id,lat:p.lat,lng:p.lng,color:p.color,title:p.title||'',notes:p.notes||''})))); }
    function loadPins(){ try{return JSON.parse(localStorage.getItem(K_PINS)||'[]')}catch{ return []} }
    function newId(){ return 'p_'+Date.now()+'_'+Math.floor(Math.random()*1e6) }
    function dot(color){ return L.divIcon({className:'',html:`<div class="marker-dot" style="background:${color}"></div>`,iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-9]}); }
    function pinPopupHtml(p){ return `<div><div style="font-weight:700;margin-bottom:6px;">House note</div>
      <label>Label</label><input id="t_${p.id}" style="width:100%;margin:2px 0 6px;" value="${(p.title||'').replace(/"/g,'&quot;')}">
      <label>Notes</label><textarea id="n_${p.id}" rows="3" style="width:100%;margin-top:2px;">${(p.notes||'')}</textarea>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
        ${PALETTE.map(c=>`<button data-c="${c}" class="btn" style="background:${c};border-color:${c};color:#000;">&nbsp;</button>`).join('')}
        <button class="btn" id="del_${p.id}" style="background:#fee;border-color:#fee;">Delete</button>
      </div></div>`; }
    function bindPinPopup(m,p){
      m.bindPopup(pinPopupHtml(p));
      m.on('popupopen',()=>{
        const el=m.getPopup().getElement();
        el.querySelectorAll('button[data-c]').forEach(b=>b.addEventListener('click',()=>{
          p.color=b.getAttribute('data-c'); m.setIcon(dot(p.color)); savePins();
        }));
        el.querySelector('#del_'+p.id).addEventListener('click',()=>{ map.removeLayer(m); pins.delete(p.id); savePins(); });
        el.querySelector('#t_'+p.id).addEventListener('input',e=>{ p.title=e.target.value; savePins(); });
        el.querySelector('#n_'+p.id).addEventListener('input',e=>{ p.notes=e.target.value; savePins(); });
      });
    }
    function addPinLL(latlng,color){
      const p={id:newId(),lat:latlng.lat,lng:latlng.lng,color:color||COLOR_MAP.NOT_VISITED};
      const m=L.marker(latlng,{icon:dot(p.color)}).addTo(map);
      bindPinPopup(m,p); p._m=m; pins.set(p.id,p); savePins();
    }
    loadPins().forEach(o=>{ const m=L.marker([o.lat,o.lng],{icon:dot(o.color)}).addTo(map); const p={...o,_m:m}; pins.set(p.id,p); bindPinPopup(m,p); });

    // ===== Car
    let car=null, carMarker=null;
    function carIcon(){ return L.divIcon({className:'',html:`<div class="car-emoji">ðŸš—</div>`,iconSize:[26,26],iconAnchor:[13,13]}); }
    function placeCar(latlng){ if(carMarker){ carMarker.remove(); } car={lat:latlng.lat,lng:latlng.lng}; localStorage.setItem(K_CAR, JSON.stringify(car)); carMarker=L.marker(latlng,{icon:carIcon(),interactive:true}).addTo(map); bindCarDrag(); }
    (function(){ try{ const c=JSON.parse(localStorage.getItem(K_CAR)||'null'); if(c){ placeCar(c); } }catch{} })();

    function bindCarDrag(){
      if(!carMarker) return;
      const icon = carMarker._icon;
      if(!icon) return;
      let timer=null, dragging=false, pointerId=null;
      const offset={x:-16,y:-24};
      function onDown(e){
        if(e.pointerType==='touch' && e.isPrimary===false) return;
        e.preventDefault();
        clearTimeout(timer);
        timer=setTimeout(()=>{
          dragging=true; pointerId=e.pointerId;
          showShield(); // capture all gestures
          map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
          icon.setPointerCapture && icon.setPointerCapture(pointerId);
        },700);
      }
      function onMove(e){
        if(!dragging || e.pointerId!==pointerId) return;
        e.preventDefault();
        const pt=map.mouseEventToContainerPoint(e);
        const pinPt={x:pt.x+offset.x,y:pt.y+offset.y};
        const ll=map.containerPointToLatLng(pinPt);
        carMarker.setLatLng(ll);
      }
      function endDrag(e){
        clearTimeout(timer);
        if(dragging && e.pointerId===pointerId){
          e.preventDefault();
          const pt=map.mouseEventToContainerPoint(e);
          const pinPt={x:pt.x+offset.x,y:pt.y+offset.y};
          const ll=map.containerPointToLatLng(pinPt);
          placeCar(ll);
        }
        dragging=false; pointerId=null;
        hideShield();
        map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
      }
      icon.addEventListener('pointerdown', onDown, {passive:false});
      icon.addEventListener('pointermove', onMove, {passive:false});
      icon.addEventListener('pointerup', endDrag, {passive:false});
      icon.addEventListener('pointercancel', endDrag, {passive:false});
    }

    // ===== Menu
    const settings=document.getElementById('settingsPanel');
    document.getElementById('menuBtn').onclick=()=>settings.classList.toggle('show');
    document.getElementById('closeSettings').onclick=()=>settings.classList.remove('show');
    document.addEventListener('pointerdown', (e)=>{
      const t=e.target;
      if(!(t.closest('.toolbar')||t.closest('.fab')||t.closest('.leaflet-control'))) settings.classList.remove('show');
    }, {passive:true});

    // ===== Palette (long-press anywhere; choose color or car) using shield
    const palette=document.getElementById('palette');
    let longTimer=null, pressPt=null, pressLL=null, paletteOpen=false, selected='note:'+COLOR_MAP.NOT_VISITED, primaryPointer=null;
    function buildPalette(){
      palette.innerHTML = ''
        + PALETTE.map(c=>`<div class="opt" data-type="note" data-color="${c}" style="background:${c}"></div>`).join('')
        + `<div class="opt" data-type="car" style="background:#fff;">ðŸš—</div>`;
    }
    function showPalette(pt){ buildPalette(); palette.style.left=(pt.x-110)+'px'; palette.style.top=(pt.y-80)+'px'; palette.style.display='block'; paletteOpen=true; }
    function hidePalette(){ palette.style.display='none'; paletteOpen=false; }
    const mapEl=map.getContainer();
    mapEl.addEventListener('pointerdown', (e)=>{
      if(primaryPointer!==null) return;
      if(e.pointerType==='touch' && e.isPrimary===false) return;
      if(e.target.closest('.leaflet-marker-icon')) return;
      primaryPointer=e.pointerId;
      pressPt=map.mouseEventToContainerPoint(e);
      pressLL=map.containerPointToLatLng(pressPt);
      clearTimeout(longTimer);
      longTimer=setTimeout(()=>{
        showShield(); showPalette(pressPt);
        map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
      },1000);
    }, {passive:false});
    shield.addEventListener('pointermove', (e)=>{
      if(!paletteOpen || e.pointerId!==primaryPointer) return;
      e.preventDefault();
      const el=document.elementFromPoint(e.clientX, e.clientY);
      if(el && el.classList && el.classList.contains('opt')){
        Array.from(palette.children).forEach(c=>c.classList.toggle('selected', c===el));
        selected = el.getAttribute('data-type')==='car' ? 'car' : ('note:'+el.getAttribute('data-color'));
      }
    }, {passive:false});
    function endPalette(e){
      if(primaryPointer===null || e.pointerId!==primaryPointer) return;
      clearTimeout(longTimer);
      if(paletteOpen){
        const choice=selected;
        hidePalette(); hideShield();
        map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
        if(choice==='car'){ if(you){ placeCar(you.getLatLng()); } else { placeCar(pressLL); } }
        else if(choice.startsWith('note:')){ addPinLL(pressLL, choice.split(':')[1]); }
      } else {
        hideShield();
      }
      primaryPointer=null;
    }
    shield.addEventListener('pointerup', endPalette, {passive:false});
    shield.addEventListener('pointercancel', endPalette, {passive:false});
    map.on('movestart', ()=>{ clearTimeout(longTimer); hidePalette(); hideShield(); primaryPointer=null; });

    // ===== Perimeter drawing using shield (no auto-close line while drawing)
    let drawing=false, drawPointer=null, drawLine=null, perimPoly=null, perimPts=[];
    function savePerim(){ localStorage.setItem(K_PERIM, JSON.stringify(perimPts.map(ll=>({lat:ll.lat,lng:ll.lng})))); }
    function loadPerim(){ try{ const a=JSON.parse(localStorage.getItem(K_PERIM)||'null'); if(a&&a.length){ perimPts=a.map(o=>L.latLng(o.lat,o.lng)); if(perimPoly) perimPoly.remove(); perimPoly=L.polygon(perimPts,{color:'#2563eb',weight:3,opacity:0.8,fill:true,fillOpacity:0.08}).addTo(map);} }catch{} }
    function clearPerim(){ if(drawLine){ drawLine.remove(); drawLine=null; } if(perimPoly){ perimPoly.remove(); perimPoly=null; } perimPts=[]; localStorage.removeItem(K_PERIM); }
    loadPerim();

    document.getElementById('drawPerimeterBtn').onclick=()=>{
      drawing=true; drawPointer=null; perimPts=[];
      if(drawLine) { drawLine.remove(); drawLine=null; }
      if(perimPoly) { perimPoly.remove(); perimPoly=null; }
      drawLine=L.polyline([], {color:'#2563eb',weight:3,opacity:0.9}).addTo(map);
      document.getElementById('drawHint').style.display='block';
      showShield();
      map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
      toast('Drawingâ€¦');
    };
    document.getElementById('clearPerimeterBtn').onclick=()=>{ clearPerim(); toast('Perimeter cleared'); };

    shield.addEventListener('pointerdown', (e)=>{
      if(!drawing || drawPointer!==null) return;
      drawPointer=e.pointerId;
      const ll=map.mouseEventToLatLng(e);
      perimPts=[ll];
      drawLine.setLatLngs(perimPts);
    }, {passive:false});

    shield.addEventListener('pointermove', (e)=>{
      if(!drawing || e.pointerId!==drawPointer) return;
      e.preventDefault();
      const ll=map.mouseEventToLatLng(e);
      perimPts.push(ll);
      drawLine.setLatLngs(perimPts);
    }, {passive:false});

    function endDrawing(e){
      if(!drawing || e.pointerId!==drawPointer) return;
      drawing=false;
      document.getElementById('drawHint').style.display='none';
      hideShield();
      map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
      if(perimPts.length>2){
        if(drawLine){ drawLine.remove(); drawLine=null; }
        perimPoly=L.polygon(perimPts, {color:'#2563eb',weight:3,opacity:0.9,fill:true,fillOpacity:0.08}).addTo(map);
        savePerim(); toast('Perimeter saved');
      }else{
        clearPerim();
      }
      drawPointer=null;
    }
    shield.addEventListener('pointerup', endDrawing, {passive:false});
    shield.addEventListener('pointercancel', endDrawing, {passive:false});
    // Multi-touch on shield will be ignored since touch-action: none; only primary pointer used

    // ===== Route (same as before)
    let route=null, progress=null;
    function clearRoute(){ if(route){ route.remove(); route=null; } if(progress){ progress.remove(); progress=null; } localStorage.removeItem(K_ROUTE); }
    function drawRoute(lls){
      if(route) route.remove();
      route=L.polyline(lls,{color:'#8e44ad',weight:5,opacity:0.8}).addTo(map);
      if(progress) progress.remove();
      progress=L.polyline([], {color:'#27ae60',weight:6,opacity:0.9}).addTo(map);
    }
    function distM(a,b){
      const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(A));
    }
    function projectPointToPolyline(P, line){
      if(!line || line.length<2) return {ok:false};
      let best={ok:false, perp:Infinity, along:0}; let cum=0;
      for(let i=0;i<line.length-1;i++){
        const A=line[i], B=line[i+1];
        const res=projectToSeg(P,A,B,cum); if(res.perp<best.perp){ best=res; } cum=res.cumNext;
      }
      return best;
    }
    function projectToSeg(P,A,B,cumBefore){
      const pA=map.latLngToLayerPoint(A), pB=map.latLngToLayerPoint(B), pP=map.latLngToLayerPoint(P);
      const AB={x:pB.x-pA.x,y:pB.y-pA.y}, AP={x:pP.x-pA.x,y:pP.y-pA.y};
      const ab2=AB.x*AB.x+AB.y*AB.y; let t=ab2===0?0:(AP.x*AB.x+AP.y*AB.y)/ab2; t=Math.max(0,Math.min(1,t));
      const projPx={x:pA.x+t*AB.x,y:pA.y+t*AB.y}; const projLL=map.layerPointToLatLng(projPx);
      const seg=distM(A,B); const perp=distM(P,projLL); const along=cumBefore+seg*t;
      return {ok:true, perp, along, cumNext:cumBefore+seg};
    }
    function updateProgress(along){
      if(!route||!progress) return;
      const lls=route.getLatLngs(); const out=[]; let remain=along;
      for(let i=0;i<lls.length-1;i++){
        const A=lls[i], B=lls[i+1]; const seg=distM(A,B);
        if(remain<=0) break;
        if(remain>=seg){ if(out.length===0) out.push(A); out.push(B); remain-=seg; }
        else { if(out.length===0) out.push(A);
          const t=remain/seg; const pA=map.latLngToLayerPoint(A), pB=map.latLngToLayerPoint(B);
          const pX={x:pA.x+t*(pB.x-pA.x), y:pA.y+t*(pB.y-pA.y)}; out.push(map.layerPointToLatLng(pX)); break; }
      }
      progress.setLatLngs(out);
    }

    function insidePolygon(ptLatLng, polyLL){
      const pts=polyLL.map(ll=>map.latLngToLayerPoint(ll)); const x=map.latLngToLayerPoint(ptLatLng).x, y=map.latLngToLayerPoint(ptLatLng).y;
      let inside=false;
      for(let i=0,j=pts.length-1;i<pts.length;j=i++){
        const xi=pts[i].x, yi=pts[i].y, xj=pts[j].x, yj=pts[j].y;
        const intersect=((yi>y)!=(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi)+xi);
        if(intersect) inside=!inside;
      }
      return inside;
    }

    function generateSweepRoute(){
      if(!car || !perimPoly){ toast('Set car and draw perimeter first'); return; }
      const perimPtsLL = perimPoly.getLatLngs()[0];
      const bbox=perimPtsLL.reduce((b,ll)=>({minX:Math.min(b.minX,ll.lng), maxX:Math.max(b.maxX,ll.lng), minY:Math.min(b.minY,ll.lat), maxY:Math.max(b.maxY,ll.lat)}),{minX:Infinity,maxX:-Infinity,minY:Infinity,maxY:-Infinity});
      const spacingM=40;
      const mPerDegLat=111320, mPerDegLng=111320*Math.cos((car.lat||map.getCenter().lat)*Math.PI/180);
      const dy=spacingM/mPerDegLat;
      const startLat=bbox.minY+dy/2, endLat=bbox.maxY-dy/2;
      const xs=[bbox.minX,bbox.maxX];
      let lines=[]; let dir=0;
      function inside(ll){ return insidePolygon(ll, perimPtsLL); }
      for(let y=startLat; y<=endLat; y+=dy){
        const a=L.latLng(y, xs[dir?1:0]), b=L.latLng(y, xs[dir?0:1]);
        const samples=60; const seg=[];
        for(let i=0;i<=samples;i++){
          const lng=a.lng + (b.lng-a.lng)*(i/samples);
          const ll=L.latLng(y,lng);
          if(inside(ll)) seg.push(ll);
        }
        if(seg.length>1){ lines.push(seg); dir=1-dir; }
      }
      const path=[L.latLng(car.lat,car.lng)]; let cur=path[0];
      function d(a,b){ return distM(a,b); }
      while(lines.length){
        let best={idx:0, rev:false, d:Infinity};
        lines.forEach((seg,idx)=>{
          const a=seg[0], b=seg[seg.length-1];
          const d1=d(cur,a), d2=d(cur,b);
          if(d1<best.d){ best={idx,rev:false,d:d1}; }
          if(d2<best.d){ best={idx,rev:true,d:d2}; }
        });
        const seg=lines.splice(best.idx,1)[0];
        const use=best.rev? seg.slice().reverse(): seg;
        path.push(...use);
        cur=use[use.length-1];
      }
      path.push(L.latLng(car.lat,car.lng));
      drawRoute(path); toast('Route generated');
    }

    document.getElementById('autorouteBtn').onclick=generateSweepRoute;
    document.getElementById('clearRouteBtn').onclick=()=>{ if(route){ route.remove(); route=null; } if(progress){ progress.remove(); progress=null; } };

    // progress coloring
    if(navigator.geolocation){
      navigator.geolocation.watchPosition(pos=>{
        const ll=L.latLng(pos.coords.latitude,pos.coords.longitude);
        if(you) you.setLatLng(ll);
        if(route){
          const best=projectPointToPolyline(ll, route.getLatLngs());
          if(best.ok) updateProgress(best.along);
        }
      }, err=>console.warn(err), {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
    }

    // ===== Settings actions
    document.getElementById('exportPins').onclick=()=>{
      const data=JSON.stringify(Array.from(pins.values()).map(({_m, ...o})=>o),null,2);
      const url=URL.createObjectURL(new Blob([data],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='pins.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('importPins').onclick=()=>document.getElementById('importPinsFile').click();
    document.getElementById('importPinsFile').addEventListener('change',ev=>{
      const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{
        try{ const arr=JSON.parse(r.result); pins.forEach(p=>p._m.remove()); pins.clear();
          arr.forEach(o=>{ const m=L.marker([o.lat,o.lng],{icon:dot(o.color||COLOR_MAP.NOT_VISITED)}).addTo(map); const p={...o,_m=m}; pins.set(p.id,p); bindPinPopup(m,p); });
          savePins(); toast('Pins imported'); }catch(e){ alert('Import failed'); }
      }; r.readAsText(f);
    });
    document.getElementById('clearPins').onclick=()=>{ pins.forEach(p=>p._m.remove()); pins.clear(); savePins(); };
    document.getElementById('setCarGPS').onclick=()=>{ if(you){ placeCar(you.getLatLng()); } };
    document.getElementById('centerCar').onclick=()=>{ if(carMarker){ map.panTo(carMarker.getLatLng()); } };
    document.getElementById('clearCar').onclick=()=>{ if(carMarker){ carMarker.remove(); carMarker=null; } car=null; localStorage.removeItem(K_CAR); };
    document.getElementById('resetAll').onclick=()=>{
      pins.forEach(p=>p._m.remove()); pins.clear(); localStorage.removeItem(K_PINS);
      if(carMarker){ carMarker.remove(); carMarker=null; } car=null; localStorage.removeItem(K_CAR);
      if(route){ route.remove(); route=null; } if(progress){ progress.remove(); progress=null; } localStorage.removeItem(K_ROUTE);
      if(perimPoly){ perimPoly.remove(); perimPoly=null; } if(drawLine){ drawLine.remove(); drawLine=null; } perimPts=[]; localStorage.removeItem(K_PERIM);
      hideShield();
      toast('All cleared');
    };
  </script>
</body>
</html>
