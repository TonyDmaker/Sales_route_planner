<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Route Planner â€” base_shell_v3 + Perimeter (v3.1)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; }
  #app { position:relative; height:100vh; width:100vw; overflow:hidden; }
  #map { position:absolute; inset:0; }
  .panel {
    position:absolute; z-index:1000; background:rgba(255,255,255,0.98);
    border-radius:12px; padding:12px; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    box-shadow:0 2px 10px rgba(0,0,0,0.15); font-size:14px;
    user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .legend { top:10px; left:10px; }
  .toolbar { top:60px; right:10px; width:320px; max-width:92vw; max-height:70vh; overflow:auto; display:none; }
  .toolbar.show { display:block; }
  .row { display:flex; align-items:center; gap:6px; margin:4px 0; flex-wrap:wrap; }
  .btn {
    display:inline-block; padding:6px 10px; margin:2px 4px 2px 0; border:1px solid #ddd; border-radius:8px;
    background:#f7f7f7; cursor:pointer; user-select:none;
  }
  .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
  .marker-dot { width:18px; height:18px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 3px rgba(0,0,0,0.5); }
  .car-emoji { font-size:26px; line-height:26px; transform:translate(-2px,-2px); }
  .palette {
    position:absolute; z-index:1102; background:#fff; border-radius:12px; padding:8px; display:none;
    box-shadow:0 4px 12px rgba(0,0,0,0.25); border:1px solid #0001;
    user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .palette .opt { width:36px; height:36px; border-radius:50%; border:2px solid #fff;
    display:inline-flex; align-items:center; justify-content:center; margin:6px;
    box-shadow:0 0 4px rgba(0,0,0,.2); cursor:pointer;
  }
  .fab {
    position:absolute; top:10px; right:10px; z-index:1103;
    width:44px; height:44px; border-radius:50%; border:none;
    background:#111; color:#fff; font-size:22px; line-height:44px; text-align:center;
    box-shadow:0 3px 10px rgba(0,0,0,0.3); cursor:pointer;
    user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .toast { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    background:rgba(0,0,0,.65); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:1200; }
  .hint { position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,.7); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:1200; }
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <button id="menuBtn" class="fab" title="Settings">â˜°</button>
  <div id="toast" class="toast"></div>
  <div id="drawHint" class="hint">Draw a loop, lift to finish</div>

  <div class="panel legend" id="legendPanel">
    <div style="font-weight:700;margin-bottom:6px;">Legend</div>
    <div class="row"><div class="marker-dot" style="background:#000000;"></div> Not visited</div>
    <div class="row"><div class="marker-dot" style="background:#3498db;"></div> Visited</div>
    <div class="row"><div class="marker-dot" style="background:#f1c40f;"></div> Followâ€‘up</div>
    <div class="row"><div class="marker-dot" style="background:#2ecc71;"></div> Wants to buy</div>
    <div class="row"><div class="marker-dot" style="background:#e74c3c;"></div> No soliciting</div>
    <div class="row"><span class="car-emoji">ðŸš—</span> Parking</div>
  </div>

  <div class="panel toolbar" id="settingsPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Settings</div>
      <button class="btn" id="closeSettings">Close</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Pins</div>
    <div class="row">
      <button class="btn" id="exportPins">Export</button>
      <button class="btn" id="importPins">Import</button>
      <input type="file" id="importPinsFile" accept="application/json" style="display:none;">
      <button class="btn" id="clearPins">Clear</button>
    </div>

    <div style="margin-top:6px;font-weight:700;">Parking & Area</div>
    <div class="row">
      <button class="btn" id="setParking">Set Parking (tap map)</button>
      <button class="btn" id="centerCar">Center on Parking</button>
      <button class="btn" id="clearCar">Clear Parking</button>
    </div>
    <div class="row">
      <button class="btn" id="drawPerimeterBtn">Draw perimeter</button>
      <button class="btn" id="clearPerimeterBtn">Clear perimeter</button>
    </div>
  </div>

  <div id="palette" class="palette"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== Constants
const COLOR = { NOT_VISITED:'#000000', VISITED:'#3498db', FOLLOW_UP:'#f1c40f', WANTS:'#2ecc71', NO_SOLICIT:'#e74c3c' };
const PALETTE = [COLOR.NOT_VISITED, COLOR.VISITED, COLOR.FOLLOW_UP, COLOR.WANTS, COLOR.NO_SOLICIT];

// ===== Utilities
function toast(msg,ms=900){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }

// ===== Map init (same as v3)
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
map.setView([37.773972,-122.431297], 13);
if (navigator.geolocation) map.locate({setView:true,maxZoom:18});

// ===== Menu (same behavior)
const menuBtn=document.getElementById('menuBtn');
const settings=document.getElementById('settingsPanel');
menuBtn.addEventListener('click', ()=> settings.classList.toggle('show'));
document.getElementById('closeSettings').addEventListener('click', ()=> settings.classList.remove('show'));
document.addEventListener('pointerdown', (e)=>{
  const t=e.target;
  if(!(t.closest('.toolbar')||t.closest('.fab')||t.closest('.leaflet-control'))) settings.classList.remove('show');
},{passive:true});

// ===== Pins (same as v3, with working Clear)
const pins=new Map();
function newId(){ return 'p_'+Date.now()+'_'+Math.floor(Math.random()*1e6); }
function dot(color){ return L.divIcon({className:'',html:`<div class="marker-dot" style="background:${color}"></div>`,iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-9]}); }
function pinPopupHtml(p){ return `<div style="-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;">
  <div style="font-weight:700;margin-bottom:6px;">House note</div>
  <label>Label</label><input id="t_${p.id}" style="width:100%;margin:2px 0 6px;" value="${(p.title||'').replace(/"/g,'&quot;')}">
  <label>Notes</label><textarea id="n_${p.id}" rows="3" style="width:100%;margin-top:2px;">${(p.notes||'')}</textarea>
  <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
    ${PALETTE.map(c=>`<button data-c="${c}" class="btn" style="background:${c};border-color:${c};color:#000;">&nbsp;</button>`).join('')}
    <button class="btn" id="del_${p.id}" style="background:#fee;border-color:#fee;">Delete</button>
  </div></div>`; }
function bindPinPopup(m,p){
  m.bindPopup(pinPopupHtml(p));
  m.on('popupopen',()=>{
    const el=m.getPopup().getElement();
    el.querySelectorAll('button[data-c]').forEach(b=>b.addEventListener('click',()=>{
      p.color=b.getAttribute('data-c'); m.setIcon(dot(p.color)); savePins();
    }));
    el.querySelector('#del_'+p.id).addEventListener('click',()=>{ map.removeLayer(m); pins.delete(p.id); savePins(); });
    el.querySelector('#t_'+p.id).addEventListener('input',e=>{ p.title=e.target.value; savePins(); });
    el.querySelector('#n_'+p.id).addEventListener('input',e=>{ p.notes=e.target.value; savePins(); });
  });
}
function addPinAtLL(latlng,color){
  const p={id:newId(),lat:latlng.lat,lng:latlng.lng,color:color||COLOR.NOT_VISITED,title:'',notes:''};
  const m=L.marker(latlng,{icon:dot(p.color)}).addTo(map);
  p._m=m; pins.set(p.id,p); bindPinPopup(m,p); savePins();
}
function savePins(){ localStorage.setItem('srp_v3pins', JSON.stringify(Array.from(pins.values()).map(({_m,...o})=>o))); }
(function loadPins(){ try{ const arr=JSON.parse(localStorage.getItem('srp_v3pins')||'[]'); arr.forEach(o=>{ const m=L.marker([o.lat,o.lng],{icon:dot(o.color)}).addTo(map); const p={...o,_m:m}; pins.set(p.id,p); bindPinPopup(m,p); }); }catch{} })();
document.getElementById('clearPins').addEventListener('click', ()=>{ settings.classList.remove('show'); pins.forEach(p=>p._m.remove()); pins.clear(); savePins(); });
document.getElementById('exportPins').addEventListener('click', ()=>{
  const data=JSON.stringify(Array.from(pins.values()).map(({_m,...o})=>o),null,2);
  const url=URL.createObjectURL(new Blob([data],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='pins.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('importPins').addEventListener('click', ()=>document.getElementById('importPinsFile').click());
document.getElementById('importPinsFile').addEventListener('change', ev=>{
  const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{
    try{ const arr=JSON.parse(r.result); pins.forEach(p=>p._m.remove()); pins.clear();
      arr.forEach(o=>{ const m=L.marker([o.lat,o.lng],{icon:dot(o.color||COLOR.NOT_VISITED)}).addTo(map); const p={...o,_m=m}; pins.set(p.id,p); bindPinPopup(m,p); });
      savePins(); toast('Pins imported'); }catch(e){ alert('Import failed'); }
  }; r.readAsText(f);
});

// ===== Car pin (place via menu "Set Parking" or palette ðŸš—; move via long-press)
let car=null, carMarker=null;
function carIcon(){ return L.divIcon({className:'',html:`<div class="car-emoji">ðŸš—</div>`,iconSize:[26,26],iconAnchor:[13,13]}); }
function placeCar(latlng){ if(carMarker){ carMarker.remove(); } car={lat:latlng.lat,lng:latlng.lng}; localStorage.setItem('srp_v3car', JSON.stringify(car)); carMarker=L.marker(latlng,{icon:carIcon(),interactive:true}).addTo(map); bindCarDrag(); }
(function loadCar(){ try{ const c=JSON.parse(localStorage.getItem('srp_v3car')||'null'); if(c){ placeCar(c); } }catch{} })();
function bindCarDrag(){
  if(!carMarker) return; const icon=carMarker._icon; if(!icon) return;
  let timer=null, dragging=false, pointerId=null; const offset={x:-16,y:-24};
  function onDown(e){ if(e.pointerType==='touch' && e.isPrimary===false) return; e.preventDefault(); clearTimeout(timer);
    timer=setTimeout(()=>{ dragging=true; pointerId=e.pointerId; map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); icon.setPointerCapture && icon.setPointerCapture(pointerId); },700);
  }
  function onMove(e){ if(!dragging || e.pointerId!==pointerId) return; e.preventDefault(); const pt=map.mouseEventToContainerPoint(e); const pinPt={x:pt.x+offset.x,y:pt.y+offset.y}; const ll=map.containerPointToLatLng(pinPt); carMarker.setLatLng(ll); }
  function onUp(e){ clearTimeout(timer); if(dragging && e.pointerId===pointerId){ e.preventDefault(); const pt=map.mouseEventToContainerPoint(e); const pinPt={x:pt.x+offset.x,y:pt.y+offset.y}; const ll=map.containerPointToLatLng(pinPt); placeCar(ll); } dragging=false; pointerId=null; map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable(); }
  icon.addEventListener('pointerdown', onDown, {passive:false});
  icon.addEventListener('pointermove', onMove, {passive:false});
  icon.addEventListener('pointerup', onUp, {passive:false});
  icon.addEventListener('pointercancel', onUp, {passive:false});
}
document.getElementById('setParking').addEventListener('click', ()=>{ settings.classList.remove('show'); toast('Tap the map to set parking'); map.once('click', e=>placeCar(e.latlng)); });
document.getElementById('centerCar').addEventListener('click', ()=>{ settings.classList.remove('show'); if(carMarker){ map.panTo(carMarker.getLatLng()); } });
document.getElementById('clearCar').addEventListener('click', ()=>{ settings.classList.remove('show'); if(carMarker){ carMarker.remove(); carMarker=null; } car=null; localStorage.removeItem('srp_v3car'); });

// ===== Long-press palette (tap to choose option)
const palette=document.getElementById('palette');
let longTimer=null, pressPt=null, pressLL=null;
function buildPalette(){
  palette.innerHTML = ''
    + PALETTE.map(c=>`<div class="opt" data-type="note" data-color="${c}" style="background:${c}"></div>`).join('')
    + `<div class="opt" data-type="car" style="background:#fff;">ðŸš—</div>`;
}
function showPalette(pt){
  buildPalette();
  palette.style.left=(pt.x-110)+'px'; palette.style.top=(pt.y-80)+'px';
  palette.style.display='block';
}
function hidePalette(){ palette.style.display='none'; }
const mapEl=map.getContainer();
mapEl.addEventListener('pointerdown', (e)=>{
  if(e.target.closest('.leaflet-marker-icon')) return;
  if(e.pointerType==='touch' && e.isPrimary===false) return;
  pressPt=map.mouseEventToContainerPoint(e); pressLL=map.containerPointToLatLng(pressPt);
  clearTimeout(longTimer); longTimer=setTimeout(()=>{ showPalette(pressPt); },1000);
},{passive:false});
mapEl.addEventListener('pointermove', (e)=>{
  if(!longTimer) return;
  const pt=map.mouseEventToContainerPoint(e);
  if(Math.hypot(pt.x-pressPt.x, pt.y-pressPt.y)>8){ clearTimeout(longTimer); longTimer=null; }
},{passive:false});
// tap on palette select
palette.addEventListener('click', (e)=>{
  const opt=e.target.closest('.opt'); if(!opt) return;
  const type=opt.getAttribute('data-type');
  if(type==='car'){ placeCar(pressLL); } else { addPinAtLL(pressLL, opt.getAttribute('data-color')); }
  hidePalette();
});

// ===== Perimeter drawing (minimal, no overlay)
let drawing=false, drawLine=null, perimPoly=null, perimPts=[];
function clearPerim(){ if(drawLine){ drawLine.remove(); drawLine=null;} if(perimPoly){ perimPoly.remove(); perimPoly=null;} perimPts=[]; }
document.getElementById('clearPerimeterBtn').addEventListener('click', ()=>{ settings.classList.remove('show'); clearPerim(); });

document.getElementById('drawPerimeterBtn').addEventListener('click', ()=>{
  settings.classList.remove('show');
  if(drawing) return;
  drawing=true; perimPts=[];
  if(drawLine) drawLine.remove(); if(perimPoly){ perimPoly.remove(); perimPoly=null; }
  drawLine=L.polyline([], {color:'#f97316', weight:3, opacity:0.9}).addTo(map); // orange
  document.getElementById('drawHint').style.display='block';
  map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
  toast('Drawingâ€¦');
});

function finishDraw(){
  drawing=false;
  document.getElementById('drawHint').style.display='none';
  map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable();
  if(perimPts.length>2){
    if(drawLine){ drawLine.remove(); drawLine=null; }
    perimPoly=L.polygon(perimPts, {color:'#2563eb', weight:3, opacity:0.9, fill:true, fillOpacity:0.08}).addTo(map);
    toast('Perimeter saved');
  } else {
    clearPerim();
  }
}

// capture drawing on map container
mapEl.addEventListener('pointerdown', (e)=>{
  if(!drawing) return;
  if(e.pointerType==='touch' && e.isPrimary===false) return; // ignore second finger
  e.preventDefault();
  perimPts=[];
  perimPts.push(map.mouseEventToLatLng(e));
  drawLine.setLatLngs(perimPts);
}, {passive:false});
mapEl.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  e.preventDefault();
  perimPts.push(map.mouseEventToLatLng(e));
  drawLine.setLatLngs(perimPts);
}, {passive:false});
mapEl.addEventListener('pointerup', (e)=>{
  if(!drawing) return;
  e.preventDefault();
  finishDraw();
}, {passive:false});
mapEl.addEventListener('pointercancel', (e)=>{
  if(!drawing) return;
  e.preventDefault();
  finishDraw();
}, {passive:false});

</script>
</body>
</html>
