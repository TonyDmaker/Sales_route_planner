<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Sales Route Planner â€” Modular v6 (Parking + Perimeter)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body { height: 100%; margin: 0; }
#map { height: 100%; width: 100%; }
.panel { position: absolute; z-index: 1000; background: rgba(255,255,255,0.98); border-radius: 12px; padding: 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 14px; }
.legend { top: 10px; left: 10px; }
.toolbar { top: 60px; right: 10px; width: 320px; max-width: 92vw; max-height: 70vh; overflow: auto; display: none; }
.toolbar.show { display: block; }
.row { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
.swatch { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #0002; }
.icon { width: 16px; height: 16px; display:inline-flex; align-items:center; justify-content:center; font-size:16px; }
.btn { display: inline-block; padding: 6px 10px; margin: 2px 4px 2px 0; border: 1px solid #ddd; border-radius: 8px; background: #f7f7f7; cursor: pointer; user-select: none; }
.btn.active { background: #e5f1ff; border-color: #b3d2ff; }
.section-title { font-weight:700; margin-top:8px; }
.popup-form label { display:block; margin: 6px 0 2px; font-weight: 600; }
.popup-form input, .popup-form select, .popup-form textarea { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
.popup-actions { display:flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.marker-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
.hint { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background: rgba(0,0,0,0.75); color:white; padding:6px 10px; border-radius:8px; font-size:12px; }
.palette { position: absolute; z-index: 1100; background: white; border-radius: 12px; padding: 8px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.25); border: 1px solid #0001; }
.palette .choice { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.2); margin: 6px; display: inline-flex; align-items:center; justify-content:center; }
.palette .choice.car { font-size: 20px; border-radius: 10px; width: 44px; height: 44px; }
.palette .choice.selected { outline: 3px solid rgba(0,0,0,0.25); }
.fab { position: absolute; top: 10px; right: 10px; z-index: 1101; width: 44px; height: 44px; border-radius: 50%; border: none; background: #111; color: #fff; font-size: 22px; line-height: 44px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.3); cursor: pointer; }
.toast { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.65); color: #fff; padding: 6px 10px; border-radius: 8px; font-size: 12px; display:none; z-index: 1200; }
.pill { display:inline-block; padding: 2px 6px; border-radius: 10px; background:#eef3ff; border:1px solid #d8e4ff; font-size:12px; }
</style>
</head>
<body>
<div id="map"></div>
<button id="menuBtn" class="fab" title="Settings">â˜°</button>
<div id="toast" class="toast"></div>
<div class="panel legend" id="legendPanel">
  <div style="font-weight:700;margin-bottom:6px;">Legend</div>
  <div class="row"><span class="swatch" style="background:#666;"></span> Not visited</div>
  <div class="row"><span class="swatch" style="background:#2ecc71;"></span> Visited</div>
  <div class="row"><span class="swatch" style="background:#e74c3c;"></span> No soliciting</div>
  <div class="row"><span class="swatch" style="background:#3498db;"></span> Follow-up</div>
  <div class="row"><span class="swatch" style="background:#f1c40f;"></span> Wants to buy</div>
  <div class="row"><span class="icon">ðŸš—</span> Parking</div>
  <div class="row"><span class="pill">Perimeter</span> Freehand area</div>
</div>
<div class="panel toolbar" id="settingsPanel">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-weight:700;">Settings</div>
    <button class="btn" id="closeSettings">Close</button>
  </div>
  <div class="section-title">Feature toggles</div>
  <label><input type="checkbox" id="tglLongPress" checked> Longâ€‘press palette (1s)</label>
  <label><input type="checkbox" id="tglRoute" checked> Route tools (add/finish/clear)</label>
  <label><input type="checkbox" id="tglProgress" checked> Show progress coloring along route</label>
  <label><input type="checkbox" id="tglAutoVisit" checked> Autoâ€‘mark pins visited when route passes</label>
  <label><input type="checkbox" id="tglLegend" checked> Show legend</label>
  <label><input type="checkbox" id="tglTapDetails" checked> Tap marker opens details popup</label>
  <div class="section-title">Parking</div>
  <div class="row flex">
    <button class="btn" id="setParkingGPSBtn">Set Parking (my GPS)</button>
    <button class="btn" id="centerCarBtn">Center on Car</button>
    <button class="btn" id="clearParkingBtn">Clear Parking</button>
  </div>
  <div class="section-title">Perimeter</div>
  <div class="row flex">
    <button class="btn" id="drawPerimeterBtn">Draw perimeter</button>
    <button class="btn" id="clearPerimeterBtn">Clear perimeter</button>
    <button class="btn" id="autoRouteBtn">Auto-route within perimeter</button>
  </div>
  <div style="font-size:12px;color:#444;">Draw by dragging your finger around the car. Route will start and end at ðŸš— and visit pins <em>inside</em> the area.</div>
  <div class="section-title">Pins</div>
  <div class="row flex">
    <button class="btn" id="exportBtn">Export Pins</button>
    <button class="btn" id="importBtn">Import Pins</button>
    <input type="file" id="importFile" accept="application/json" style="display:none;" />
    <button class="btn" id="clearPinsBtn">Clear Pins</button>
  </div>
</div>
<div id="hint" class="hint" style="display:none;">Longâ€‘press 1s â†’ choose a color or ðŸš— â†’ release</div>
<div id="palette" class="palette"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const STATUS = {
  NOT_VISITED: { key:'NOT_VISITED', label: 'Not visited', color: '#666666' },
  VISITED: { key:'VISITED', label: 'Visited', color: '#2ecc71' },
  NO_SOLICITING: { key:'NO_SOLICITING', label: 'No soliciting', color: '#e74c3c' },
  FOLLOW_UP: { key:'FOLLOW_UP', label: 'Follow-up', color: '#3498db' },
  WANTS_TO_BUY: { key:'WANTS_TO_BUY', label: 'Wants to buy', color: '#f1c40f' }
};
const STATUS_LIST = [STATUS.NOT_VISITED, STATUS.VISITED, STATUS.NO_SOLICITING, STATUS.FOLLOW_UP, STATUS.WANTS_TO_BUY];
const STORAGE_PINS = 'srp_mod_pins_v6';
const STORAGE_ROUTE = 'srp_mod_route_v2';
const STORAGE_PARK = 'srp_parking_v1';
const STORAGE_PERI = 'srp_perimeter_v1';
const HOLD_MS_DEFAULT = 1000;

function makeDot(color){return L.divIcon({className:'custom-dot',html:'<div class="marker-dot" style="background:'+color+'"></div>',iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-9]});}
function carIcon(){return L.divIcon({className:'car-icon',html:'<div style="font-size:22px;filter: drop-shadow(0 1px 1px rgba(0,0,0,.4));">ðŸš—</div>',iconSize:[22,22],iconAnchor:[11,11]});}
function newId(){return 'p_'+Date.now()+'_'+Math.floor(Math.random()*1e6);}
function escapeHtml(str){return (str||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function distM(a,b){const R=6371000,toRad=d=>d*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;return 2*R*Math.asin(Math.sqrt(A));}
function toast(msg,ms=900){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',ms);}
function pointInPolygon(latlng, poly){let x=latlng.lng,y=latlng.lat,inside=false;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const xi=poly[i].lng,yi=poly[i].lat;const xj=poly[j].lng,yj=poly[j].lat;const intersect=((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi);if(intersect) inside=!inside;}return inside;}

const map = L.map('map').fitWorld();
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let youAreHere=null,lastGPS=null;
map.locate({setView:true,maxZoom:18});
map.on('locationfound',e=>{lastGPS=e.latlng;if(!youAreHere){youAreHere=L.marker(e.latlng).addTo(map).bindPopup('You are here');}});
map.on('locationerror',e=>console.warn(e));

const pins=new Map();
function savePins(){localStorage.setItem(STORAGE_PINS,JSON.stringify(Array.from(pins.values()).map(({_marker,_chain,...rest})=>rest)));}
function loadPins(){try{return JSON.parse(localStorage.getItem(STORAGE_PINS)||'[]');}catch{return[];}}

let parkingMarker=null;
function saveParking(ll){if(ll){localStorage.setItem(STORAGE_PARK,JSON.stringify(ll));}else{localStorage.removeItem(STORAGE_PARK);}}
function loadParking(){try{return JSON.parse(localStorage.getItem(STORAGE_PARK)||'null');}catch{return null;}}
function setParkingAt(ll){if(!ll){toast('No GPS yet');return;} if(parkingMarker){map.removeLayer(parkingMarker);} parkingMarker=L.marker(ll,{icon:carIcon(),draggable:false}).addTo(map).bindPopup('Parking'); attachCarLongPress(parkingMarker); saveParking(ll);}
function centerOnCar(){ if(parkingMarker){ map.setView(parkingMarker.getLatLng(), Math.max(16,map.getZoom()||16)); } else { toast('No parking set'); } }
function attachCarLongPress(marker){const el=marker.getElement(); if(!el){marker.on('add',()=>attachCarLongPress(marker));return;} let timer=null,pressing=false; el.addEventListener('pointerdown',ev=>{pressing=true; timer=setTimeout(()=>{if(pressing){marker.dragging.enable(); toast('Drag car to move');}},700);}); function end(){pressing=false;clearTimeout(timer);} el.addEventListener('pointerup',end); el.addEventListener('pointercancel',end); marker.on('dragend',()=>{marker.dragging.disable(); saveParking(marker.getLatLng());});}

let perimeter=null;
function savePerimeter(latlngs){ if(latlngs&&latlngs.length){ localStorage.setItem(STORAGE_PERI, JSON.stringify(latlngs)); } else { localStorage.removeItem(STORAGE_PERI); } }
function loadPerimeter(){ try{ return JSON.parse(localStorage.getItem(STORAGE_PERI)||'[]'); }catch{ return []; } }
function renderPerimeter(latlngs){ if(perimeter){ map.removeLayer(perimeter); perimeter=null; } if(!latlngs||!latlngs.length) return; perimeter=L.polygon(latlngs,{color:'#3aa3ff',weight:2,fillColor:'#3aa3ff',fillOpacity:0.08}).addTo(map); }

let routePoints=loadRoute();
let routePoly=null,progressPoly=null;
function saveRoute(){localStorage.setItem(STORAGE_ROUTE,JSON.stringify(routePoints));}
function loadRoute(){try{return JSON.parse(localStorage.getItem(STORAGE_ROUTE)||'[]');}catch{return[];}}
function renderRoute(){ if(routePoly){map.removeLayer(routePoly);routePoly=null;} if(progressPoly){map.removeLayer(progressPoly);progressPoly=null;} if(routePoints.length<2) return; routePoly=L.polyline(routePoints,{color:'#8e44ad',weight:5,opacity:0.75}).addTo(map); if(document.getElementById('tglProgress').checked){progressPoly=L.polyline([], {color:'#27ae60',weight:6,opacity:0.9}).addTo(map);} recomputePinProjections(); saveRoute(); }
function updateProgressPolyline(){ if(progressPoly){ progressPoly.setLatLngs([]);} }
function projectPointToPolyline(P,line){ if(!line||line.length<2) return {ok:false}; let best={ok:false,perpM:Infinity,alongM:0,proj:null}; let cum=0; for(let i=0;i<line.length-1;i++){ const A=line[i],B=line[i+1]; const res=projectPointToSegment(P,A,B,cum); if(res.perpM<best.perpM){best=res;} cum=res.cumNext;} return best; }
function projectPointToSegment(P,A,B,cumBefore){ const mapA=map.latLngToLayerPoint(A), mapB=map.latLngToLayerPoint(B), mapP=map.latLngToLayerPoint(P); const AB={x:mapB.x-mapA.x,y:mapB.y-mapA.y}; const AP={x:mapP.x-mapA.x,y:mapP.y-mapA.y}; const ab2=AB.x*AB.x+AB.y*AB.y; let t=ab2===0?0:(AP.x*AB.x+AP.y*AB.y)/ab2; t=Math.max(0,Math.min(1,t)); const projPx={x:mapA.x+t*AB.x,y:mapA.y+t*AB.y}; const projLatLng=map.layerPointToLatLng(projPx); const segLenM=distM(A,B); const perpM=distM(P,projLatLng); const alongM=cumBefore+segLenM*t; return {ok:true,proj:projLatLng,perpM,alongM,cumNext:cumBefore+segLenM}; }
function recomputePinProjections(){ pins.forEach(p=>{ if(routePoints.length<2){ p._chain=null; return; } const proj=projectPointToPolyline({lat:p.lat,lng:p.lng},routePoints); p._chain=proj.ok?{alongM:proj.alongM,perpM:proj.perpM}:null; }); }

function markerPopupHtml(p){return `<div class="popup-form">
  <label>Label</label>
  <input type="text" id="title_${p.id}" value="${escapeHtml(p.title||'')}" placeholder="e.g., 123 Main St"/>
  <label>Status</label>
  <select id="status_${p.id}">${STATUS_LIST.map(s=>`<option value="${s.key}" ${p.status===s.key?'selected':''}>${s.label}</option>`).join('')}</select>
  <label>Notes</label>
  <textarea id="notes_${p.id}" rows="3">${escapeHtml(p.notes||'')}</textarea>
  <label><input type="checkbox" id="keep_${p.id}" ${p.keepUnvisited?'checked':''}/> Keep as Unvisited (donâ€™t auto-change)</label>
  <div class="popup-actions">
    <button class="btn" data-action="save" data-id="${p.id}">Save</button>
    <button class="btn" data-action="visited" data-id="${p.id}">Mark Visited</button>
    <button class="btn" data-action="delete" data-id="${p.id}" style="background:#ffecec;">Delete</button>
    <button class="btn" data-action="setcar" data-id="${p.id}">Set Parking (my GPS) ðŸš—</button>
  </div></div>`;}
function attachPopupHandlers(marker,p){ const el=marker.getPopup().getElement(); if(!el) return; el.querySelectorAll('button[data-action]').forEach(btn=>{ btn.addEventListener('click',()=>{ const action=btn.getAttribute('data-action'); if(action==='save'){ p.title=el.querySelector('#title_'+p.id).value.trim(); p.status=el.querySelector('#status_'+p.id).value; p.notes=el.querySelector('#notes_'+p.id).value.trim(); p.keepUnvisited=el.querySelector('#keep_'+p.id).checked; updateMarker(p); savePins(); marker.setPopupContent(markerPopupHtml(p)); attachPopupHandlers(marker,p);
} else if(action==='visited'){ p.status='VISITED'; updateMarker(p); savePins(); marker.setPopupContent(markerPopupHtml(p)); attachPopupHandlers(marker,p);
} else if(action==='delete'){ map.removeLayer(marker); pins.delete(p.id); savePins();
} else if(action==='setcar'){ if(!lastGPS){ toast('GPS not ready'); } else { setParkingAt(lastGPS); toast('Parking set at GPS'); } } }); }); }
function createMarker(p){ const m=L.marker([p.lat,p.lng],{icon:makeDot((STATUS_LIST.find(s=>s.key===p.status)||STATUS.NOT_VISITED).color)}); if(document.getElementById('tglTapDetails').checked){ m.bindPopup(markerPopupHtml(p)); m.on('popupopen',()=>attachPopupHandlers(m,p)); } p._marker=m; m.addTo(map); }
function updateMarker(p){ if(p._marker){ p._marker.setIcon(makeDot((STATUS_LIST.find(s=>s.key===p.status)||STATUS.NOT_VISITED).color)); if(document.getElementById('tglTapDetails').checked && !p._marker.getPopup()){ p._marker.bindPopup(markerPopupHtml(p)); p._marker.on('popupopen',()=>attachPopupHandlers(p._marker,p)); } if(!document.getElementById('tglTapDetails').checked && p._marker.getPopup()){ p._marker.unbindPopup(); } } }
loadPins().forEach(obj=>{ const p={...obj}; pins.set(p.id,p); createMarker(p); });

const palette=document.getElementById('palette');
let paletteActive=false, paletteChoice=null, pressTimer=null, pressing=false, pressStartPt=null, pressLatLng=null;
function buildPalette(){ let html=''; STATUS_LIST.forEach(s=>{ html+=`<div class="choice" data-type="color" data-key="${s.key}" style="background:${s.color}" title="${s.label}"></div>`; }); html+=`<div class="choice car" data-type="car" title="Set Parking (GPS)">ðŸš—</div>`; palette.innerHTML=html; }
function showPalette(pt){ buildPalette(); palette.style.left=(pt.x-120)+'px'; palette.style.top=(pt.y-90)+'px'; palette.style.display='block'; paletteActive=true; paletteChoice={type:'color',key:STATUS.NOT_VISITED.key}; if(navigator.vibrate){try{navigator.vibrate(10);}catch(e){}} }
function hidePalette(){ palette.style.display='none'; paletteActive=false; }
function selectFromPoint(x,y){ const el=document.elementFromPoint(x,y); if(!el) return; if(el.classList.contains('choice')){ const type=el.getAttribute('data-type')||'car'; paletteChoice = (type==='color') ? {type:'color',key:el.getAttribute('data-key')} : {type:'car'}; Array.from(palette.querySelectorAll('.choice')).forEach(e=>e.classList.toggle('selected', e===el)); } }

const settingsPanel=document.getElementById('settingsPanel');
document.getElementById('menuBtn').addEventListener('click',()=>settingsPanel.classList.toggle('show'));
document.getElementById('closeSettings').addEventListener('click',()=>settingsPanel.classList.remove('show'));
function isClickInsideUI(target){ return target.closest && (target.closest('.toolbar')||target.closest('.legend')||target.closest('.palette')||target.closest('.fab')||target.closest('.leaflet-control')); }
document.addEventListener('pointerdown',e=>{ if(!isClickInsideUI(e.target)) settingsPanel.classList.remove('show'); });

let routeAddMode=false;
document.getElementById('routeAddBtn')?.addEventListener('click',()=>{ routeAddMode=!routeAddMode; document.getElementById('routeAddBtn').classList.toggle('active',routeAddMode); if(routeAddMode && routePoints.length===0 && parkingMarker){ routePoints.push(parkingMarker.getLatLng()); renderRoute(); } });
document.getElementById('routeFinishBtn')?.addEventListener('click',()=>{ if(parkingMarker && routePoints.length>0){ const last=routePoints[routePoints.length-1]; const car=parkingMarker.getLatLng(); if(last.lat!==car.lat||last.lng!==car.lng){ routePoints.push(car);} } renderRoute(); });
document.getElementById('routeClearBtn')?.addEventListener('click',()=>{ routePoints=[]; renderRoute(); });
map.on('click',e=>{ if(routeAddMode && document.getElementById('tglRoute').checked){ routePoints.push(e.latlng); renderRoute(); } });

document.getElementById('exportBtn').addEventListener('click',()=>{ const data=JSON.stringify(Array.from(pins.values()).map(({_marker,_chain,...rest})=>rest),null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sales_route_pins.json'; a.click(); URL.revokeObjectURL(url); });
document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change',ev=>{ const file=ev.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); pins.forEach(p=>{ if(p._marker) map.removeLayer(p._marker); }); pins.clear(); arr.forEach(obj=>{ const p={...obj,id:obj.id||newId()}; pins.set(p.id,p); createMarker(p); }); savePins(); recomputePinProjections(); }catch(err){ alert('Import failed: '+err.message);} }; r.readAsText(file); });
document.getElementById('clearPinsBtn').addEventListener('click',()=>{ pins.forEach(p=>{ if(p._marker) map.removeLayer(p._marker); }); pins.clear(); savePins(); });

const MOVE_TOL_PX=8;
const mapContainer=map.getContainer();
function startPress(ev){ if(!document.getElementById('tglLongPress').checked || routeAddMode) return; pressing=true; pressStartPt=map.mouseEventToContainerPoint(ev); pressLatLng=map.containerPointToLatLng(pressStartPt); clearTimeout(pressTimer); pressTimer=setTimeout(()=>{ if(pressing){ showPalette(pressStartPt); map.dragging.disable(); map.scrollWheelZoom.disable(); } }, HOLD_MS_DEFAULT); }
function movePress(ev){ if(!pressing) return; const pt=map.mouseEventToContainerPoint(ev); const dx=pt.x-pressStartPt.x, dy=pt.y-pressStartPt.y; if(!paletteActive && Math.hypot(dx,dy)>MOVE_TOL_PX){ cancelPress(); } if(paletteActive){ selectFromPoint(ev.clientX, ev.clientY); ev.preventDefault(); } }
function endPress(ev){ if(paletteActive){ if(paletteChoice && paletteChoice.type==='color'){ const statusKey=paletteChoice.key; const p={ id:newId(), lat:pressLatLng.lat, lng:pressLatLng.lng, title:'', notes:'', status:statusKey, keepUnvisited:false }; pins.set(p.id,p); createMarker(p); savePins(); recomputePinProjections(); toast('Pin added'); } else if(paletteChoice && paletteChoice.type==='car'){ if(!lastGPS){ toast('GPS not ready'); } else { setParkingAt(lastGPS); toast('Parking set'); } } hidePalette(); } cancelPress(); }
function cancelPress(){ pressing=false; clearTimeout(pressTimer); map.dragging.enable(); map.scrollWheelZoom.enable(); }
mapContainer.addEventListener('pointerdown',ev=>{ if(isClickInsideUI(ev.target)) return; startPress(ev); });
mapContainer.addEventListener('pointermove',ev=>{ movePress(ev); });
mapContainer.addEventListener('pointerup',ev=>{ endPress(ev); });
mapContainer.addEventListener('pointercancel',()=>{ cancelPress(); hidePalette(); });
map.on('movestart',()=>{ hidePalette(); cancelPress(); });

document.getElementById('setParkingGPSBtn').addEventListener('click',()=>{ if(!lastGPS){ toast('GPS not ready'); } else { setParkingAt(lastGPS); toast('Parking set'); } });
document.getElementById('centerCarBtn').addEventListener('click',centerOnCar);
document.getElementById('clearParkingBtn').addEventListener('click',()=>{ if(parkingMarker){ map.removeLayer(parkingMarker); parkingMarker=null; saveParking(null); } });

let drawing=false, drawPts=[];
document.getElementById('drawPerimeterBtn').addEventListener('click',()=>{ if(!parkingMarker){ toast('Set parking first'); return; } toast('Draw the perimeter'); drawing=true; drawPts=[]; map.dragging.disable(); map.scrollWheelZoom.disable(); });
mapContainer.addEventListener('pointerdown',ev=>{ if(!drawing) return; drawPts=[ map.mouseEventToLatLng(ev) ]; });
mapContainer.addEventListener('pointermove',ev=>{ if(!drawing || drawPts.length===0) return; const ll=map.mouseEventToLatLng(ev); drawPts.push(ll); renderPerimeter(drawPts); ev.preventDefault(); });
function finishDrawing(){ if(!drawing) return; drawing=false; map.dragging.enable(); map.scrollWheelZoom.enable(); if(drawPts.length>2){ renderPerimeter(drawPts); savePerimeter(drawPts); toast('Perimeter saved'); } else { if(perimeter){ map.removeLayer(perimeter); perimeter=null; } savePerimeter(null); toast('Perimeter cleared'); } drawPts=[]; }
mapContainer.addEventListener('pointerup',()=>finishDrawing());
mapContainer.addEventListener('pointercancel',()=>finishDrawing());
document.getElementById('clearPerimeterBtn').addEventListener('click',()=>{ if(perimeter){ map.removeLayer(perimeter); perimeter=null; } savePerimeter(null); });

document.getElementById('autoRouteBtn').addEventListener('click',()=>{
  if(!parkingMarker){ toast('Set parking first'); return; }
  const car=parkingMarker.getLatLng();
  const periLL = perimeter ? perimeter.getLatLngs()[0] : loadPerimeter();
  if(!periLL || periLL.length<3){ toast('Draw a perimeter first'); return; }
  const insidePins = Array.from(pins.values()).filter(p=>pointInPolygon({lat:p.lat,lng:p.lng}, periLL));
  const remaining=insidePins.slice();
  const path=[car];
  let cur=car;
  while(remaining.length){ let bi=0, bd=Infinity; for(let i=0;i<remaining.length;i++){ const d=distM(cur,{lat:remaining[i].lat,lng:remaining[i].lng}); if(d<bd){bd=d; bi=i;} } const next=remaining.splice(bi,1)[0]; path.push({lat:next.lat,lng:next.lng}); cur={lat:next.lat,lng:next.lng}; }
  path.push(car);
  routePoints=path; renderRoute(); toast('Route generated');
});

(function initLoad(){ const savedCar=loadParking(); if(savedCar){ setParkingAt(savedCar); } const peri=loadPerimeter(); if(peri&&peri.length>2){ renderPerimeter(peri); } renderRoute(); const h=document.getElementById('hint'); h.style.display='block'; setTimeout(()=>h.style.display='none',2500); })();

if(navigator.geolocation){ navigator.geolocation.watchPosition(pos=>{ const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude}; lastGPS=latlng; if(youAreHere){ youAreHere.setLatLng(latlng);} else { youAreHere=L.marker(latlng).addTo(map).bindPopup('You are here'); } if(routePoints.length>=2){ const proj=projectPointToPolyline(latlng,routePoints); if(proj.ok){ if(document.getElementById('tglProgress').checked){ updateProgressPolyline(); } if(document.getElementById('tglAutoVisit').checked){ const distLimit=35; pins.forEach(p=>{ if(p.status==='VISITED'||p.keepUnvisited) return; if(!p._chain) return; if(p._chain.perpM<=distLimit && proj.alongM>=p._chain.alongM){ p.status='VISITED'; updateMarker(p); savePins(); } }); } } } }, err=>console.warn(err), {enableHighAccuracy:true,maximumAge:5000,timeout:10000}); }
</script>
</body>
</html>